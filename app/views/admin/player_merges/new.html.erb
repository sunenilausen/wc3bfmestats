<% content_for :title, "Merge #{@source_player.nickname}" %>

<div class="w-full max-w-2xl mx-auto">
  <h1 class="font-bold text-3xl mb-6">Merge Player</h1>

  <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
    <p class="text-yellow-800 font-medium">Warning: This action cannot be undone!</p>
    <p class="text-yellow-700 text-sm mt-1">
      All matches, appearances, and lobby assignments from the source player will be transferred to the target player.
      The source player will be permanently deleted.
    </p>
  </div>

  <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
    <h2 class="font-semibold text-lg mb-2">Source Player (will be deleted)</h2>
    <div class="flex items-center gap-4">
      <div>
        <p class="text-xl font-medium"><%= @source_player.nickname %></p>
        <p class="text-sm text-gray-500">
          <%= @source_player.battletag %>
          <% if @source_player.alternative_name.present? %>
            | <%= @source_player.alternative_name %>
          <% end %>
        </p>
        <p class="text-sm text-gray-600 mt-1">
          <span class="text-green-600"><%= @source_player.wins %>W</span> /
          <span class="text-red-600"><%= @source_player.losses %>L</span>
          (<%= @source_player.matches.where(ignored: false).count %> matches)
        </p>
        <% if @source_player.custom_rating %>
          <p class="text-sm text-gray-600">CR: <%= @source_player.custom_rating.round %></p>
        <% end %>
        <% if @source_player.alternative_battletags.present? %>
          <p class="text-sm text-gray-500 mt-1">
            Alt battletags: <%= @source_player.alternative_battletags.join(", ") %>
          </p>
        <% end %>
      </div>
    </div>
  </div>

  <%= form_with url: admin_player_merge_path(@source_player), method: :post, local: true, class: "space-y-6" do |f| %>
    <div>
      <label for="target_player_id" class="block text-sm font-medium text-gray-700 mb-2">
        Target Player (will receive all data)
      </label>
      <select name="target_player_id" id="target_player_id" required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <option value="">Select a player...</option>
        <% @players.each do |player| %>
          <option value="<%= player.id %>"
                  data-matches="<%= player.matches.where(ignored: false).count %>"
                  data-wins="<%= player.wins %>"
                  data-losses="<%= player.losses %>">
            <%= player.nickname %>
            <% if player.alternative_name.present? %>(<%= player.alternative_name %>)<% end %>
            - <%= player.matches.where(ignored: false).count %> matches
            <% if player.battletag.present? %>
              [<%= player.battletag %>]
            <% end %>
          </option>
        <% end %>
      </select>
    </div>

    <div id="target-preview" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h2 class="font-semibold text-lg mb-2">Target Player Preview</h2>
      <div id="target-details"></div>
    </div>

    <div class="flex items-center gap-4">
      <%= f.submit "Merge Players", class: "px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-md cursor-pointer",
          data: { turbo_confirm: "Are you absolutely sure you want to merge #{@source_player.nickname} into the selected player? This cannot be undone." } %>
      <%= link_to "Cancel", player_path(@source_player), class: "px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-md" %>
    </div>
  <% end %>
</div>

<script>
  document.getElementById('target_player_id').addEventListener('change', function() {
    const preview = document.getElementById('target-preview');
    const details = document.getElementById('target-details');
    const selected = this.options[this.selectedIndex];

    if (this.value) {
      const matches = selected.dataset.matches;
      const wins = selected.dataset.wins;
      const losses = selected.dataset.losses;

      details.innerHTML = `
        <p class="text-lg font-medium">${selected.text.split(' - ')[0]}</p>
        <p class="text-sm text-gray-600 mt-1">
          <span class="text-green-600">${wins}W</span> /
          <span class="text-red-600">${losses}L</span>
          (${matches} matches)
        </p>
        <p class="text-sm text-blue-700 mt-2">
          After merge: ${parseInt(matches) + <%= @source_player.matches.where(ignored: false).count %>} total matches
        </p>
      `;
      preview.classList.remove('hidden');
    } else {
      preview.classList.add('hidden');
    }
  });
</script>
