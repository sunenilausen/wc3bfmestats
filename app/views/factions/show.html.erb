<% content_for :title, @faction.name %>

<div class="w-full">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block" id="notice"><%= notice %></p>
  <% end %>

  <div class="flex items-center gap-3 mb-6">
    <h1 class="font-bold text-4xl"><%= @faction.name %></h1>
    <span class="px-2 py-1 rounded text-sm font-medium <%= @faction.good? ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700' %>">
      <%= @faction.good? ? "Good" : "Evil" %>
    </span>
  </div>

  <%# Stats Cards %>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Kill Averages</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Hero Kills/game</td>
            <td class="text-right py-0.5"><%= @stats[:avg_hero_kills] %></td>
          </tr>
          <tr>
            <td class="py-0.5">Hero Kills/min</td>
            <td class="text-right py-0.5"><%= @stats[:avg_hero_kills_per_min] %></td>
          </tr>
          <tr>
            <td class="py-0.5">Unit Kills/game</td>
            <td class="text-right py-0.5"><%= @stats[:avg_unit_kills] %></td>
          </tr>
          <tr>
            <td class="py-0.5">Unit Kills/min</td>
            <td class="text-right py-0.5"><%= @stats[:avg_unit_kills_per_min] %></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Team Contribution</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Avg Hero Kill Share</td>
            <td class="text-right py-0.5"><%= @stats[:avg_hero_kill_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5">Top Hero Killer</td>
            <td class="text-right py-0.5"><%= @stats[:times_top_hero_kills] %>x (<%= @stats[:top_hero_kills_pct] %>%)</td>
          </tr>
          <tr>
            <td class="py-0.5">Avg Unit Kill Share</td>
            <td class="text-right py-0.5"><%= @stats[:avg_unit_kill_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5">Top Unit Killer</td>
            <td class="text-right py-0.5"><%= @stats[:times_top_unit_kills] %>x (<%= @stats[:top_unit_kills_pct] %>%)</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Overview</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Unique Players</td>
            <td class="text-right py-0.5"><%= @stats[:unique_players] %></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <%# Leaderboards %>
  <h2 class="text-xl font-bold mb-3">Leaderboards</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <%# Highest Win Rate %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Highest Win Rate <span class="text-xs text-gray-400">(min 10 games)</span></h3>
      <% if @stats[:top_winrate_players].any? %>
        <table class="w-full text-sm">
          <tbody>
            <% @stats[:top_winrate_players].each_with_index do |data, i| %>
              <tr class="<%= i < @stats[:top_winrate_players].size - 1 ? 'border-b border-gray-100' : '' %>">
                <td class="py-1"><%= i + 1 %>. <%= link_to data[:player].nickname, player_path(data[:player]), class: "text-blue-600 hover:underline" %></td>
                <td class="text-right py-1">
                  <span class="text-green-600 font-medium"><%= data[:winrate] %>%</span>
                  <span class="text-gray-400 text-xs">(<%= data[:wins] %>W/<%= data[:games] %>G)</span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="text-gray-400 text-sm">No players with 10+ games yet.</p>
      <% end %>
    </div>

    <%# Most Wins %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Most Wins</h3>
      <% if @stats[:most_wins_players].any? %>
        <table class="w-full text-sm">
          <tbody>
            <% @stats[:most_wins_players].each_with_index do |data, i| %>
              <tr class="<%= i < @stats[:most_wins_players].size - 1 ? 'border-b border-gray-100' : '' %>">
                <td class="py-1"><%= i + 1 %>. <%= link_to data[:player].nickname, player_path(data[:player]), class: "text-blue-600 hover:underline" %></td>
                <td class="text-right py-1">
                  <span class="text-green-600 font-medium"><%= data[:wins] %></span>
                  <span class="text-gray-400 text-xs">(<%= data[:games] %> games)</span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="text-gray-400 text-sm">No players found.</p>
      <% end %>
    </div>

    <%# Top Hero Killers %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Top Hero Killers <span class="text-xs text-gray-400">(min 5 games)</span></h3>
      <% if @stats[:top_hero_killers].any? %>
        <table class="w-full text-sm">
          <tbody>
            <% @stats[:top_hero_killers].each_with_index do |data, i| %>
              <tr class="<%= i < @stats[:top_hero_killers].size - 1 ? 'border-b border-gray-100' : '' %>">
                <td class="py-1"><%= i + 1 %>. <%= link_to data[:player].nickname, player_path(data[:player]), class: "text-blue-600 hover:underline" %></td>
                <td class="text-right py-1">
                  <span class="font-medium"><%= data[:top_pct] %>%</span>
                  <span class="text-gray-400 text-xs">(<%= data[:top_hero] %>/<%= data[:games] %>)</span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="text-gray-400 text-sm">No players with 5+ games yet.</p>
      <% end %>
    </div>

    <%# Top Unit Killers %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Top Unit Killers <span class="text-xs text-gray-400">(min 5 games)</span></h3>
      <% if @stats[:top_unit_killers].any? %>
        <table class="w-full text-sm">
          <tbody>
            <% @stats[:top_unit_killers].each_with_index do |data, i| %>
              <tr class="<%= i < @stats[:top_unit_killers].size - 1 ? 'border-b border-gray-100' : '' %>">
                <td class="py-1"><%= i + 1 %>. <%= link_to data[:player].nickname, player_path(data[:player]), class: "text-blue-600 hover:underline" %></td>
                <td class="text-right py-1">
                  <span class="font-medium"><%= data[:top_pct] %>%</span>
                  <span class="text-gray-400 text-xs">(<%= data[:top_unit] %>/<%= data[:games] %>)</span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="text-gray-400 text-sm">No players with 5+ games yet.</p>
      <% end %>
    </div>
  </div>

  <div class="flex gap-2">
    <%= link_to "Edit", edit_faction_path(@faction), class: "rounded-md px-3 py-2 bg-gray-100 hover:bg-gray-50 text-sm font-medium" %>
    <%= link_to "Back", factions_path, class: "rounded-md px-3 py-2 bg-gray-100 hover:bg-gray-50 text-sm font-medium" %>
  </div>
</div>
