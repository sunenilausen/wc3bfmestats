<div>
  <h1 class="font-bold text-4xl">BfME Stats</h1>

  <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
    <div class="flex items-start gap-3">
      <span class="bg-yellow-400 text-yellow-900 text-xs font-semibold px-2 py-1 rounded">BETA</span>
      <div class="text-sm text-yellow-800">
        <p class="font-medium">This site is currently in beta and under active development.</p>
        <p class="mt-1">Player ratings, ML scores, and statistics are being tuned and may change as we improve the algorithms. Data is imported from wc3stats.com replays and some historical match ordering may be imperfect due to limitations in the source data.</p>
      </div>
    </div>
  </div>

  <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Matches</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @matches_count %></p>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Players</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @players_count %></p>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Observers</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @observers_count %></p>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Underdog Win Rate</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @underdog_stats[:percentage] %>%</p>
      <p class="mt-1 text-sm text-gray-500">
        <%= @underdog_stats[:underdog_wins] %> of <%= @underdog_stats[:total_matches] %> matches won by lower ELO team
      </p>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Good vs Evil</h2>
      <div class="mt-2 flex items-baseline gap-2">
        <span class="text-2xl font-bold text-green-600"><%= @good_vs_evil_stats[:good_percentage] %>%</span>
        <span class="text-gray-400">vs</span>
        <span class="text-2xl font-bold text-red-600"><%= @good_vs_evil_stats[:evil_percentage] %>%</span>
      </div>
      <p class="mt-1 text-sm text-gray-500">
        <span class="text-green-600"><%= @good_vs_evil_stats[:good_wins] %> Good</span> /
        <span class="text-red-600"><%= @good_vs_evil_stats[:evil_wins] %> Evil</span>
        wins (<%= @good_vs_evil_stats[:total] %> matches)
      </p>
    </div>
  </div>

  <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <%# Most Recent Lobby %>
    <div class="bg-white rounded-lg shadow border border-gray-200">
      <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-900">Most Recent Lobby</h2>
        <% if @recent_lobby %>
          <%= link_to "View", lobby_path(@recent_lobby), class: "text-sm text-blue-600 hover:text-blue-800" %>
        <% end %>
      </div>
      <div class="p-4">
        <% if @recent_lobby %>
          <p class="text-sm text-gray-500 mb-3">Updated <%= time_ago_in_words(@recent_lobby.updated_at) %> ago</p>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <h3 class="font-medium text-green-700 mb-2">Good</h3>
              <% @recent_lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction&.good? }.each do |lp| %>
                <div class="flex justify-between py-0.5">
                  <span><%= lp.player&.nickname || (lp.is_new_player? ? "New Player" : "-") %></span>
                  <span class="text-gray-400"><%= lp.faction&.name %></span>
                </div>
              <% end %>
            </div>
            <div>
              <h3 class="font-medium text-red-700 mb-2">Evil</h3>
              <% @recent_lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction && !lp.faction.good? }.each do |lp| %>
                <div class="flex justify-between py-0.5">
                  <span><%= lp.player&.nickname || (lp.is_new_player? ? "New Player" : "-") %></span>
                  <span class="text-gray-400"><%= lp.faction&.name %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% else %>
          <p class="text-gray-500 text-center py-4">No lobbies yet</p>
        <% end %>
      </div>
    </div>

    <%# Most Recent Match %>
    <div class="bg-white rounded-lg shadow border border-gray-200">
      <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-900">Most Recent Match</h2>
        <% if @recent_match %>
          <%= link_to "View", match_path(@recent_match), class: "text-sm text-blue-600 hover:text-blue-800" %>
        <% end %>
      </div>
      <div class="p-4">
        <% if @recent_match %>
          <div class="flex justify-between items-center mb-3">
            <p class="text-sm text-gray-500">Uploaded <%= time_ago_in_words(@recent_match.uploaded_at) %> ago</p>
            <span class="text-sm font-medium <%= @recent_match.good_victory? ? 'text-green-600' : 'text-red-600' %>">
              <%= @recent_match.good_victory? ? 'Good Victory' : 'Evil Victory' %>
            </span>
          </div>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <h3 class="font-medium text-green-700 mb-2">Good</h3>
              <% @recent_match.appearances.select { |a| a.faction&.good? }.each do |app| %>
                <div class="flex justify-between py-0.5">
                  <span><%= app.player&.nickname || "-" %></span>
                  <span class="text-gray-400"><%= app.faction&.name %></span>
                </div>
              <% end %>
            </div>
            <div>
              <h3 class="font-medium text-red-700 mb-2">Evil</h3>
              <% @recent_match.appearances.select { |a| a.faction && !a.faction.good? }.each do |app| %>
                <div class="flex justify-between py-0.5">
                  <span><%= app.player&.nickname || "-" %></span>
                  <span class="text-gray-400"><%= app.faction&.name %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% else %>
          <p class="text-gray-500 text-center py-4">No matches yet</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
