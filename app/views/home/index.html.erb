<div>
  <h1 class="font-bold text-4xl">BfME Stats</h1>

  <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
    <div class="flex items-start gap-3">
      <span class="bg-yellow-400 text-yellow-900 text-xs font-semibold px-2 py-1 rounded">BETA</span>
      <div class="text-sm text-yellow-800">
        <p class="font-medium">This site is currently in beta and under active development.</p>
        <p class="mt-1">Player ratings, performance scores, and statistics are being tuned and may change as we improve the algorithms. Data is imported from wc3stats.com replays and some historical match ordering may be imperfect due to limitations in the source data.</p>
      </div>
    </div>
  </div>

  <% cache ["home_stats", StatsCacheKey.key] do %>
  <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Matches</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @matches_count %></p>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Players</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @players_count %></p>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Observers</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @observers_count %></p>
    </div>
  </div>
  <% end %>

  <%# Stats that depend on map_version param - outside cache %>
  <div class="mt-4">
    <div class="mb-3">
      <%= form_with url: root_path, method: :get, local: true, class: "flex items-center gap-2" do %>
        <span class="text-sm text-gray-500">Map version:</span>
        <%= select_tag :map_version,
          options_for_select([["All versions", ""]] + @available_map_versions.map { |v| [v, v] }, @map_version),
          class: "text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50",
          onchange: "this.form.submit()" %>
      <% end %>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl">
      <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
        <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Good vs Evil</h2>
        <div class="mt-2 flex items-baseline gap-2">
          <span class="text-2xl font-bold text-green-600"><%= @good_vs_evil_stats[:good_percentage] %>%</span>
          <span class="text-gray-400">vs</span>
          <span class="text-2xl font-bold text-red-600"><%= @good_vs_evil_stats[:evil_percentage] %>%</span>
        </div>
        <p class="mt-1 text-sm text-gray-500">
          <span class="text-green-600"><%= @good_vs_evil_stats[:good_wins] %> Good</span> /
          <span class="text-red-600"><%= @good_vs_evil_stats[:evil_wins] %> Evil</span>
          wins (<%= @good_vs_evil_stats[:total] %> matches)
        </p>
      </div>

      <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
        <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Underdog Win Rate</h2>
        <p class="mt-2 text-3xl font-bold text-purple-600"><%= @underdog_stats[:percentage] %>%</p>
        <p class="mt-1 text-sm text-gray-500">
          <%= @underdog_stats[:underdog_wins] %> of <%= @underdog_stats[:total_matches] %> matches
        </p>
      </div>

      <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
        <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Avg Match Time</h2>
        <p class="mt-2 text-3xl font-bold text-blue-600"><%= @avg_match_time[:avg_formatted] %></p>
        <p class="mt-1 text-sm text-gray-500">
          across <%= @avg_match_time[:count] %> matches
        </p>
      </div>
    </div>
  </div>

  <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <% if @my_lobby %>
      <%# Your Lobby - not cached, user-specific %>
      <div class="bg-white rounded-lg shadow border border-blue-200">
        <div class="px-4 py-2 border-b border-blue-200 bg-blue-50 flex justify-between items-center">
          <h2 class="text-sm font-semibold text-gray-900">Your Lobby</h2>
          <div class="flex gap-2">
            <%= link_to "Edit", edit_lobby_path(@my_lobby), class: "text-xs text-blue-600 hover:text-blue-800 font-medium" %>
            <%= link_to "View", lobby_path(@my_lobby), class: "text-xs text-blue-600 hover:text-blue-800" %>
          </div>
        </div>
        <div class="p-3 text-xs">
          <p class="text-gray-500 mb-2"><%= time_ago_in_words(@my_lobby.updated_at) %> ago</p>
          <div class="space-y-0.5">
            <% @my_lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction&.good? }.each do |lp| %>
              <div class="flex justify-between items-center">
                <span class="flex items-center gap-1">
                  <span class="w-2 h-2 rounded-full" style="background-color: <%= lp.faction.color_hex %>"></span>
                  <span class="text-green-700"><%= lp.player&.nickname || (lp.is_new_player? ? "New" : "-") %></span>
                </span>
                <span class="text-gray-500"><%= lp.faction&.name %></span>
              </div>
            <% end %>
            <% @my_lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction && !lp.faction.good? }.each do |lp| %>
              <div class="flex justify-between items-center">
                <span class="flex items-center gap-1">
                  <span class="w-2 h-2 rounded-full" style="background-color: <%= lp.faction.color_hex %>"></span>
                  <span class="text-red-700"><%= lp.player&.nickname || (lp.is_new_player? ? "New" : "-") %></span>
                </span>
                <span class="text-gray-500"><%= lp.faction&.name %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <% cache ["home_recent", StatsCacheKey.key, @recent_lobby&.updated_at, @recent_match&.updated_at] do %>
    <%# Most Recent Lobby %>
    <div class="bg-white rounded-lg shadow border border-gray-200">
      <div class="px-4 py-2 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-sm font-semibold text-gray-900">Recent Lobby</h2>
        <% if @recent_lobby %>
          <%= link_to "View", lobby_path(@recent_lobby), class: "text-xs text-blue-600 hover:text-blue-800" %>
        <% end %>
      </div>
      <div class="p-3 text-xs">
        <% if @recent_lobby %>
          <p class="text-gray-500 mb-2"><%= time_ago_in_words(@recent_lobby.updated_at) %> ago</p>
          <div class="space-y-0.5">
            <% @recent_lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction&.good? }.each do |lp| %>
              <div class="flex justify-between items-center">
                <span class="flex items-center gap-1">
                  <span class="w-2 h-2 rounded-full" style="background-color: <%= lp.faction.color_hex %>"></span>
                  <span class="text-green-700"><%= lp.player&.nickname || (lp.is_new_player? ? "New" : "-") %></span>
                </span>
                <span class="text-gray-500"><%= lp.faction&.name %></span>
              </div>
            <% end %>
            <% @recent_lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction && !lp.faction.good? }.each do |lp| %>
              <div class="flex justify-between items-center">
                <span class="flex items-center gap-1">
                  <span class="w-2 h-2 rounded-full" style="background-color: <%= lp.faction.color_hex %>"></span>
                  <span class="text-red-700"><%= lp.player&.nickname || (lp.is_new_player? ? "New" : "-") %></span>
                </span>
                <span class="text-gray-500"><%= lp.faction&.name %></span>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500 text-center py-2">No lobbies yet</p>
        <% end %>
      </div>
    </div>

    <%# Most Recent Match %>
    <div class="bg-white rounded-lg shadow border border-gray-200">
      <div class="px-4 py-2 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-sm font-semibold text-gray-900">Recent Match</h2>
        <% if @recent_match %>
          <%= link_to "View", match_path(@recent_match), class: "text-xs text-blue-600 hover:text-blue-800" %>
        <% end %>
      </div>
      <div class="p-3 text-xs">
        <% if @recent_match %>
          <div class="flex justify-between items-center mb-2">
            <p class="text-gray-500"><%= time_ago_in_words(@recent_match.uploaded_at) %> ago</p>
            <span class="font-medium <%= @recent_match.good_victory? ? 'text-green-600' : 'text-red-600' %>">
              <%= @recent_match.good_victory? ? 'Good' : 'Evil' %> Win
            </span>
          </div>
          <div class="space-y-0.5">
            <% @recent_match.appearances.select { |a| a.faction&.good? }.each do |app| %>
              <div class="flex justify-between items-center">
                <span class="flex items-center gap-1">
                  <span class="w-2 h-2 rounded-full" style="background-color: <%= app.faction.color_hex %>"></span>
                  <span class="text-green-700"><%= app.player&.nickname || "-" %></span>
                </span>
                <span class="text-gray-500"><%= app.faction&.name %></span>
              </div>
            <% end %>
            <% @recent_match.appearances.select { |a| a.faction && !a.faction.good? }.each do |app| %>
              <div class="flex justify-between items-center">
                <span class="flex items-center gap-1">
                  <span class="w-2 h-2 rounded-full" style="background-color: <%= app.faction.color_hex %>"></span>
                  <span class="text-red-700"><%= app.player&.nickname || "-" %></span>
                </span>
                <span class="text-gray-500"><%= app.faction&.name %></span>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500 text-center py-2">No matches yet</p>
        <% end %>
      </div>
    </div>
    <% end %>
  </div>
</div>
