<div>
  <h1 class="font-bold text-4xl">BFME Stats</h1>

  <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
    <div class="flex items-start gap-3">
      <span class="bg-yellow-400 text-yellow-900 text-xs font-semibold px-2 py-1 rounded">BETA</span>
      <div class="text-sm text-yellow-800">
        <p class="font-medium">This site is currently in beta and under active development.</p>
        <p class="mt-1">Player ratings, performance scores, and statistics are being tuned and may change as we improve the algorithms. Data is imported from wc3stats.com replays and some historical match ordering may be imperfect due to limitations in the source data.</p>
      </div>
    </div>
  </div>

  <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex items-start gap-3">
      <span class="bg-blue-500 text-white text-xs font-semibold px-2 py-1 rounded">HOW TO</span>
      <div class="text-sm text-blue-800">
        <p class="font-medium">Upload Your Replays</p>
        <p class="mt-1">To have your matches tracked on this site:</p>
        <ol class="mt-2 ml-4 list-decimal space-y-1">
          <li>Go to <a href="https://wc3stats.com/upload" target="_blank" rel="noopener" class="underline hover:text-blue-600">wc3stats.com/upload, or use the autouploader program</a></li>
          <li>Upload your BFME replay file (.w3g)</li>
          <li>Your match will automatically appear here within a few hours</li>
        </ol>
        <p class="mt-2 text-xs text-blue-600">Replays are synced periodically from wc3stats.com. Only BFME map replays are imported.</p>
      </div>
    </div>
  </div>

  <div class="mt-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
    <div class="flex items-start gap-3">
      <span class="bg-gray-500 text-white text-xs font-semibold px-2 py-1 rounded">CONTACT</span>
      <div class="text-sm text-gray-700">
        <p>For any inquiries, join the <a href="https://discord.com/invite/HK8hZHV" target="_blank" rel="noopener" class="underline hover:text-gray-900 font-medium">BFME Discord</a> and contact <span class="font-medium">Kaptajn Snaps</span>.</p>
      </div>
    </div>
  </div>

  <% cache ["home_stats", StatsCacheKey.key] do %>
  <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Matches</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @matches_count %></p>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Players</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @players_count %></p>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Observers</h2>
      <p class="mt-2 text-3xl font-bold text-blue-600"><%= @observers_count %></p>
    </div>
  </div>
  <% end %>

  <div class="mt-4 text-center">
    <%= link_to "View Detailed Statistics", statistics_path, class: "text-blue-600 hover:text-blue-800 font-medium" %>
  </div>

  <% if @my_lobby %>
  <div class="mt-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Your Lobby</h2>
    <div class="bg-white rounded-lg shadow border border-blue-200">
      <div class="px-4 py-2 border-b border-blue-200 bg-blue-50 flex justify-between items-center">
        <p class="text-xs text-gray-500"><%= time_ago_in_words(@my_lobby.updated_at) %> ago</p>
        <div class="flex gap-2">
          <%= link_to "Edit", edit_lobby_path(@my_lobby), class: "text-xs text-blue-600 hover:text-blue-800 font-medium" %>
          <%= link_to "View", lobby_path(@my_lobby), class: "text-xs text-blue-600 hover:text-blue-800" %>
        </div>
      </div>
      <div class="p-3 text-xs">
        <div class="space-y-0.5">
          <% @my_lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction&.good? }.each do |lp| %>
            <div class="flex justify-between items-center">
              <span class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full" style="background-color: <%= lp.faction.color_hex %>"></span>
                <span class="text-green-700"><%= lp.player&.nickname || (lp.is_new_player? ? "New" : "-") %></span>
              </span>
              <span class="text-gray-500"><%= lp.faction&.name %></span>
            </div>
          <% end %>
          <% @my_lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction && !lp.faction.good? }.each do |lp| %>
            <div class="flex justify-between items-center">
              <span class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full" style="background-color: <%= lp.faction.color_hex %>"></span>
                <span class="text-red-700"><%= lp.player&.nickname || (lp.is_new_player? ? "New" : "-") %></span>
              </span>
              <span class="text-gray-500"><%= lp.faction&.name %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <% end %>

  <% cache ["home_recent", StatsCacheKey.key, @recent_lobbies.maximum(:updated_at), @recent_matches.maximum(:uploaded_at)] do %>
  <%# Recent Lobbies %>
  <div class="mt-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Recent Lobbies</h2>
    <% if @recent_lobbies.any? %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <% @recent_lobbies.each do |lobby| %>
          <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-4 py-2 border-b border-gray-200 flex justify-between items-center">
              <p class="text-xs text-gray-500"><%= time_ago_in_words(lobby.updated_at) %> ago</p>
              <%= link_to "View", lobby_path(lobby), class: "text-xs text-blue-600 hover:text-blue-800" %>
            </div>
            <div class="p-3 text-xs">
              <div class="space-y-0.5">
                <% lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction&.good? }.each do |lp| %>
                  <div class="flex justify-between items-center">
                    <span class="flex items-center gap-1">
                      <span class="w-2 h-2 rounded-full" style="background-color: <%= lp.faction.color_hex %>"></span>
                      <span class="text-green-700"><%= lp.player&.nickname || (lp.is_new_player? ? "New" : "-") %></span>
                    </span>
                    <span class="text-gray-500"><%= lp.faction&.name %></span>
                  </div>
                <% end %>
                <% lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction && !lp.faction.good? }.each do |lp| %>
                  <div class="flex justify-between items-center">
                    <span class="flex items-center gap-1">
                      <span class="w-2 h-2 rounded-full" style="background-color: <%= lp.faction.color_hex %>"></span>
                      <span class="text-red-700"><%= lp.player&.nickname || (lp.is_new_player? ? "New" : "-") %></span>
                    </span>
                    <span class="text-gray-500"><%= lp.faction&.name %></span>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 text-center py-4">No lobbies yet</p>
    <% end %>
  </div>

  <%# Recent Matches %>
  <div class="mt-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Recent Matches</h2>
    <% if @recent_matches.any? %>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <% @recent_matches.each do |match| %>
          <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-4 py-2 border-b border-gray-200 flex justify-between items-center">
              <div class="flex items-center gap-2">
                <p class="text-xs text-gray-500"><%= time_ago_in_words(match.uploaded_at) %> ago</p>
                <span class="text-xs font-medium <%= match.good_victory? ? 'text-green-600' : 'text-red-600' %>">
                  <%= match.good_victory? ? 'Good' : 'Evil' %> Win
                </span>
              </div>
              <%= link_to "View", match_path(match), class: "text-xs text-blue-600 hover:text-blue-800" %>
            </div>
            <div class="p-3 text-xs">
              <div class="space-y-0.5">
                <% match.appearances.select { |a| a.faction&.good? }.each do |app| %>
                  <div class="flex justify-between items-center">
                    <span class="flex items-center gap-1">
                      <span class="w-2 h-2 rounded-full" style="background-color: <%= app.faction.color_hex %>"></span>
                      <span class="text-green-700"><%= app.player&.nickname || "-" %></span>
                    </span>
                    <span class="text-gray-500"><%= app.faction&.name %></span>
                  </div>
                <% end %>
                <% match.appearances.select { |a| a.faction && !a.faction.good? }.each do |app| %>
                  <div class="flex justify-between items-center">
                    <span class="flex items-center gap-1">
                      <span class="w-2 h-2 rounded-full" style="background-color: <%= app.faction.color_hex %>"></span>
                      <span class="text-red-700"><%= app.player&.nickname || "-" %></span>
                    </span>
                    <span class="text-gray-500"><%= app.faction&.name %></span>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 text-center py-4">No matches yet</p>
    <% end %>
  </div>
  <% end %>
</div>
