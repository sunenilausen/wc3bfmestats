<% lobby_players.each do |lobby_player| %>
  <% index = @lobby.lobby_players.index(lobby_player) %>
  <tr class="nested-fields" data-team="<%= team_number %>">
    <td class="px-4 py-2 whitespace-nowrap">
      <span style="display: inline-block; width: 16px; height: 16px; background-color: <%= lobby_player.faction.color %>; border: 1px solid #000; vertical-align: middle; margin-right: 6px;"></span>
      <span><%= lobby_player.faction.name %></span>
    </td>
    <td class="px-4 py-2 whitespace-nowrap">
      <input type="hidden" name="lobby[lobby_players_attributes][<%= index %>][faction_id]" value="<%= lobby_player.faction_id %>">
      <% if lobby_player.persisted? %>
        <input type="hidden" name="lobby[lobby_players_attributes][<%= index %>][id]" value="<%= lobby_player.id %>">
      <% end %>
      <select name="lobby[lobby_players_attributes][<%= index %>][player_id]"
              class="form-control player-select"
              data-controller="searchable-select"
              data-average-elo-target="playerSelect"
              data-action="change->average-elo#calculateAverageElo"
              data-wl-target="wl-<%= index %>"
              onchange="updateWL(this, 'wl-<%= index %>')">
        <option value="" data-wins="" data-losses="">-- Select Player --</option>
        <% @players_for_select.each do |player| %>
          <% stats = @player_stats[player.id] || { wins: 0, losses: 0 } %>
          <option value="<%= player.id %>"
                  data-elo="<%= player.elo_rating.round %>"
                  data-wins="<%= stats[:wins] %>"
                  data-losses="<%= stats[:losses] %>"
                  <%= "selected" if player.id == lobby_player.player_id %>>
            <%= player.nickname %>
          </option>
        <% end %>
      </select>
    </td>
    <td class="px-4 py-2 whitespace-nowrap" id="elo-<%= index %>">
      <% if lobby_player.player_id %>
        <% player = @players_for_select.find { |p| p.id == lobby_player.player_id } %>
        <%= player&.elo_rating&.round || "-" %>
      <% else %>
        -
      <% end %>
    </td>
    <td class="px-4 py-2 whitespace-nowrap" id="wl-<%= index %>">
      <% if lobby_player.player_id && @player_stats[lobby_player.player_id] %>
        <% stats = @player_stats[lobby_player.player_id] %>
        <span class="text-green-600"><%= stats[:wins] %>W</span>/<span class="text-red-600"><%= stats[:losses] %>L</span>
      <% else %>
        -
      <% end %>
    </td>
  </tr>
<% end %>
<tr class="average-elo-row" data-controller="average-elo" data-team="<%= team_number %>">
  <td class="px-4 py-2 font-bold">Average ELO</td>
  <td class="px-4 py-2"></td>
  <td class="px-4 py-2 font-bold">
    <span data-average-elo-target="value">
      <%= lobby_players.any? ? (lobby_players.map { |lp| lp.player&.elo_rating.to_i }.compact.sum / [lobby_players.count { |lp| lp.player.present? }, 1].max) : 0 %>
    </span>
  </td>
  <td class="px-4 py-2"></td>
</tr>
<script>
  function updateWL(select, targetId) {
    const option = select.options[select.selectedIndex];
    const wins = option.dataset.wins;
    const losses = option.dataset.losses;
    const elo = option.dataset.elo;
    const wlTarget = document.getElementById(targetId);
    const eloTarget = document.getElementById(targetId.replace('wl-', 'elo-'));
    if (wins && losses) {
      wlTarget.innerHTML = '<span class="text-green-600">' + wins + 'W</span>/<span class="text-red-600">' + losses + 'L</span>';
    } else {
      wlTarget.innerHTML = '-';
    }
    if (eloTarget) {
      eloTarget.innerHTML = elo || '-';
    }
    updatePrediction();
  }

  function updatePrediction() {
    // Get all ELO cells and calculate team averages
    const allEloCells = document.querySelectorAll('[id^="elo-"]');
    let goodElos = [];
    let evilElos = [];

    allEloCells.forEach(cell => {
      const row = cell.closest('tr');
      if (!row) return;
      const team = row.dataset.team;
      const elo = parseInt(cell.textContent);
      if (!isNaN(elo)) {
        if (team === '1') {
          goodElos.push(elo);
        } else if (team === '2') {
          evilElos.push(elo);
        }
      }
    });

    const goodAvg = goodElos.length > 0 ? goodElos.reduce((a, b) => a + b, 0) / goodElos.length : 1500;
    const evilAvg = evilElos.length > 0 ? evilElos.reduce((a, b) => a + b, 0) / evilElos.length : 1500;

    // ELO expected score formula
    const goodExpected = 1 / (1 + Math.pow(10, (evilAvg - goodAvg) / 400));
    const goodPct = Math.round(goodExpected * 100);
    const evilPct = 100 - goodPct;

    document.getElementById('good-win-bar').style.width = goodPct + '%';
    document.getElementById('good-win-pct').textContent = goodPct + '%';
    document.getElementById('evil-win-pct').textContent = evilPct + '%';
  }

  // Run on page load
  document.addEventListener('DOMContentLoaded', updatePrediction);
  document.addEventListener('turbo:load', updatePrediction);
</script>
