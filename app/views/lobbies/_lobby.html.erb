<% editable ||= false %>
<% good_players = lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction&.good? } %>
<% evil_players = lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction && !lp.faction.good? } %>
<% good_with_players = good_players.select { |lp| lp.player.present? } %>
<% evil_with_players = evil_players.select { |lp| lp.player.present? } %>
<% good_avg_ml = good_with_players.any? ? (good_with_players.sum { |lp| lp.player.ml_score.to_f } / good_with_players.size).round(1) : 0 %>
<% evil_avg_ml = evil_with_players.any? ? (evil_with_players.sum { |lp| lp.player.ml_score.to_f } / evil_with_players.size).round(1) : 0 %>
<% good_avg_cr = good_with_players.any? ? (good_with_players.sum { |lp| lp.player.custom_rating.to_i } / good_with_players.size) : 0 %>
<% evil_avg_cr = evil_with_players.any? ? (evil_with_players.sum { |lp| lp.player.custom_rating.to_i } / evil_with_players.size) : 0 %>
<%# Calculate faction-specific PERF averages %>
<% faction_perf_data = @faction_perf_stats || {} %>
<% good_fac_perfs = good_with_players.map { |lp| faction_perf_data[[lp.player_id, lp.faction_id]] }.compact %>
<% evil_fac_perfs = evil_with_players.map { |lp| faction_perf_data[[lp.player_id, lp.faction_id]] }.compact %>
<% good_avg_fac_perf = good_fac_perfs.any? ? (good_fac_perfs.sum / good_fac_perfs.size.to_f).round : nil %>
<% evil_avg_fac_perf = evil_fac_perfs.any? ? (evil_fac_perfs.sum / evil_fac_perfs.size.to_f).round : nil %>
<%# Calculate overall and faction-specific rank averages %>
<% rank_data = editable ? (@faction_rank_stats || {}) : (@faction_rank_data || {}) %>
<% overall_ranks_data = @overall_avg_ranks || {} %>
<% if editable && defined?(@players_search_data) %>
  <% good_overall_ranks = good_with_players.map { |lp| @players_search_data&.find { |p| p[:id] == lp.player_id }&.dig(:avgRank) }.compact %>
  <% evil_overall_ranks = evil_with_players.map { |lp| @players_search_data&.find { |p| p[:id] == lp.player_id }&.dig(:avgRank) }.compact %>
<% else %>
  <% good_overall_ranks = good_with_players.map { |lp| overall_ranks_data[lp.player_id] }.compact %>
  <% evil_overall_ranks = evil_with_players.map { |lp| overall_ranks_data[lp.player_id] }.compact %>
<% end %>
<% good_avg_overall_rank = good_overall_ranks.any? ? (good_overall_ranks.sum / good_overall_ranks.size.to_f).round(1) : nil %>
<% evil_avg_overall_rank = evil_overall_ranks.any? ? (evil_overall_ranks.sum / evil_overall_ranks.size.to_f).round(1) : nil %>
<% good_fac_ranks = good_with_players.map { |lp| rank_data[[lp.player_id, lp.faction_id]]&.dig(:avg) }.compact %>
<% evil_fac_ranks = evil_with_players.map { |lp| rank_data[[lp.player_id, lp.faction_id]]&.dig(:avg) }.compact %>
<% good_avg_fac_rank = good_fac_ranks.any? ? (good_fac_ranks.sum / good_fac_ranks.size.to_f).round(1) : nil %>
<% evil_avg_fac_rank = evil_fac_ranks.any? ? (evil_fac_ranks.sum / evil_fac_ranks.size.to_f).round(1) : nil %>
<% col_count = editable ? 8 : 10 %>

<div id="<%= dom_id lobby %>" class="w-full sm:w-auto <%= editable ? 'mt-2 space-y-5' : 'my-5 space-y-5' %>">
  <%= simple_form_for(lobby, html: { id: "lobby-form" }, data: editable ? { turbo_action: "replace" } : {}) do |f| %>
    <% if editable %>
      <%= f.error_notification %>
      <%= f.error_notification message: f.object.errors[:base].to_sentence if f.object.errors[:base].present? %>
    <% end %>

    <table class="min-w-full divide-y divide-gray-200 border border-gray-300 rounded-lg shadow-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faction</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Leave percentage (games left early)">Leave</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Performance score (0 = avg) / Faction performance">PERF</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Custom rating">CR</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">W/L</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Win/Loss with this faction">Fac W/L</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Overall rank / Faction rank (1=best, 5=worst)">Rank</th>
          <% unless editable %>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Last game played">Last Played</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="1 year with this faction">1y Fac</th>
          <% end %>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" data-controller="average-elo">
        <tr class="bg-gray-100">
          <td colspan="<%= col_count %>" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Forces of Middle Earth</td>
        </tr>
        <%= render partial: "lobbies/lobby_player_row", collection: good_players, as: :lp, locals: { lobby: lobby, editable: editable, team_number: 1, lobby_player_stats: @lobby_player_stats || {}, faction_specific_stats: @faction_specific_stats || {}, recent_stats: @recent_stats || {}, event_stats: @event_stats || {}, player_scores: @player_scores || {}, player_faction_stats: @player_faction_stats || {}, faction_totals: @faction_totals || {}, overall_avg_ranks: @overall_avg_ranks || {}, faction_rank_data: @faction_rank_data || {}, faction_perf_stats: @faction_perf_stats || {} } %>
        <tr class="bg-gray-50">
          <td class="px-4 py-2 font-bold text-sm">Average</td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2 font-bold text-sm">
            <span data-average-elo-target="mlValue"><%= format_perf_score(good_avg_ml.round) %></span><% if good_avg_fac_perf %><span id="good-avg-fac-perf" class="text-gray-400 font-normal">/<%= format_perf_score(good_avg_fac_perf) %></span><% else %><span id="good-avg-fac-perf" class="text-gray-400 font-normal"></span><% end %>
          </td>
          <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="crValue"><%= good_avg_cr %></span></td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2 font-bold text-sm">
            <% if good_avg_overall_rank %>
              <% rank_color = good_avg_overall_rank <= 2.5 ? 'text-green-600' : (good_avg_overall_rank >= 3.5 ? 'text-red-600' : '') %>
              <span id="good-avg-overall-rank" class="<%= rank_color %>"><%= good_avg_overall_rank %></span><% if good_avg_fac_rank %><span id="good-avg-fac-rank" class="text-gray-400 font-normal">/<%= good_avg_fac_rank %></span><% else %><span id="good-avg-fac-rank" class="text-gray-400 font-normal"></span><% end %>
            <% else %>
              <span id="good-avg-overall-rank"></span><span id="good-avg-fac-rank" class="text-gray-400 font-normal"></span>
            <% end %>
          </td>
          <% unless editable %>
            <td class="px-4 py-2"></td>
            <td class="px-4 py-2"></td>
          <% end %>
        </tr>
      </tbody>
      <tbody class="bg-white divide-y divide-gray-200" data-controller="average-elo">
        <tr class="bg-gray-100">
          <td colspan="<%= col_count %>" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Forces of Sauron</td>
        </tr>
        <%= render partial: "lobbies/lobby_player_row", collection: evil_players, as: :lp, locals: { lobby: lobby, editable: editable, team_number: 2, lobby_player_stats: @lobby_player_stats || {}, faction_specific_stats: @faction_specific_stats || {}, recent_stats: @recent_stats || {}, event_stats: @event_stats || {}, player_scores: @player_scores || {}, player_faction_stats: @player_faction_stats || {}, faction_totals: @faction_totals || {}, overall_avg_ranks: @overall_avg_ranks || {}, faction_rank_data: @faction_rank_data || {}, faction_perf_stats: @faction_perf_stats || {} } %>
        <tr class="bg-gray-50">
          <td class="px-4 py-2 font-bold text-sm">Average</td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2 font-bold text-sm">
            <span data-average-elo-target="mlValue"><%= format_perf_score(evil_avg_ml.round) %></span><% if evil_avg_fac_perf %><span id="evil-avg-fac-perf" class="text-gray-400 font-normal">/<%= format_perf_score(evil_avg_fac_perf) %></span><% else %><span id="evil-avg-fac-perf" class="text-gray-400 font-normal"></span><% end %>
          </td>
          <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="crValue"><%= evil_avg_cr %></span></td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2 font-bold text-sm">
            <% if evil_avg_overall_rank %>
              <% rank_color = evil_avg_overall_rank <= 2.5 ? 'text-green-600' : (evil_avg_overall_rank >= 3.5 ? 'text-red-600' : '') %>
              <span id="evil-avg-overall-rank" class="<%= rank_color %>"><%= evil_avg_overall_rank %></span><% if evil_avg_fac_rank %><span id="evil-avg-fac-rank" class="text-gray-400 font-normal">/<%= evil_avg_fac_rank %></span><% else %><span id="evil-avg-fac-rank" class="text-gray-400 font-normal"></span><% end %>
            <% else %>
              <span id="evil-avg-overall-rank"></span><span id="evil-avg-fac-rank" class="text-gray-400 font-normal"></span>
            <% end %>
          </td>
          <% unless editable %>
            <td class="px-4 py-2"></td>
            <td class="px-4 py-2"></td>
          <% end %>
        </tr>
      </tbody>
      <% if editable %>
        <%# Hidden select for form submission - managed by JS observers column %>
        <select name="lobby[observer_ids][]" multiple class="hidden" id="observer-select">
          <% @players_for_select.each do |player| %>
            <option value="<%= player.id %>" <%= "selected" if lobby.observer_ids.include?(player.id) %>>
              <%= player_display_name(player) %>
            </option>
          <% end %>
        </select>
      <% elsif lobby.observers.any? %>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr class="bg-gray-100">
            <td colspan="<%= col_count %>" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Observers</td>
          </tr>
          <% lobby.observers.each do |observer| %>
            <% obs_stats = @lobby_player_stats&.dig(observer.id) %>
            <tr>
              <td class="px-4 py-2 whitespace-nowrap text-sm" colspan="2">
                <%= link_to player_display_name_html(observer), player_path(observer), class: "text-blue-600 hover:underline" %>
              </td>
              <%# Leave %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% leave = observer.leave_pct %>
                <% if leave %>
                  <span class="<%= leave == 0 ? 'text-green-600' : (leave >= 20 ? 'text-red-600' : 'text-yellow-600') %>">
                    <%= leave.round %>%
                  </span>
                <% else %>
                  -
                <% end %>
              </td>
              <%# PERF %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if observer.ml_score %>
                  <span class="<%= ml_score_color_class(observer.ml_score) %> font-medium"><%= format_perf_score(observer.ml_score.round) %></span>
                <% else %>
                  -
                <% end %>
              </td>
              <%# CR %>
              <td class="px-4 py-2 whitespace-nowrap text-sm"><%= observer.custom_rating&.round || "-" %></td>
              <%# W/L %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if obs_stats %>
                  <span class="text-green-600"><%= obs_stats[:wins] %></span>/<span class="text-red-600"><%= obs_stats[:losses] %></span>
                <% else %>
                  -
                <% end %>
              </td>
              <%# Fac W/L - N/A for observers %>
              <td class="px-4 py-2 whitespace-nowrap text-sm"><span class="text-gray-400">-</span></td>
              <%# Rank %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if @overall_avg_ranks && @overall_avg_ranks[observer.id] %>
                  <% obs_avg_rank = @overall_avg_ranks[observer.id] %>
                  <span class="<%= obs_avg_rank <= 2.5 ? 'text-green-600' : (obs_avg_rank >= 3.5 ? 'text-red-600' : '') %>">
                    <%= obs_avg_rank.round(1) %>
                  </span>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
              <%# Last Played %>
              <td class="px-4 py-2 whitespace-nowrap text-sm" title="<%= observer.last_seen&.strftime('%Y-%m-%d') %>">
                <%= short_time_ago(observer.last_seen) %>
              </td>
              <%# 1y Fac - N/A for observers %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">-</td>
            </tr>
          <% end %>
        </tbody>
      <% end %>
    </table>

    <%# Prediction bar - combined CR/ML with adaptive weighting %>
    <% if editable %>
      <div id="prediction" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Win Prediction</h3>
        <div class="flex items-center gap-2">
          <span class="text-green-700 font-bold text-sm w-12">Good</span>
          <div class="flex-1 h-6 bg-red-500 rounded-full overflow-hidden">
            <div id="combined-win-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 50%"></div>
          </div>
          <span class="text-red-700 font-bold text-sm w-12 text-right">Evil</span>
        </div>
        <div class="flex justify-between text-sm mt-1">
          <span id="combined-good-pct" class="text-green-700 font-medium">50%</span>
          <span id="prediction-accuracy-label" class="text-xs text-gray-400">CR+ (improved for new players)</span>
          <span id="combined-evil-pct" class="text-red-700 font-medium">50%</span>
        </div>
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span>Avg CR: <span id="pred-good-cr" class="text-green-600">-</span> | Eff: <span id="pred-good-rank" class="text-green-600">-</span></span>
          <span>Avg CR: <span id="pred-evil-cr" class="text-red-600">-</span> | Eff: <span id="pred-evil-rank" class="text-red-600">-</span></span>
        </div>
      </div>
    <% else %>
      <% prediction = LobbyWinPredictor.new(lobby).predict %>
      <% if prediction %>
        <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Win Prediction</h3>
          <div class="flex items-center gap-2">
            <span class="text-green-700 font-bold text-sm w-12">Good</span>
            <div class="flex-1 h-6 bg-red-500 rounded-full overflow-hidden">
              <div class="h-full bg-green-500" style="width: <%= prediction[:good_win_pct] %>%"></div>
            </div>
            <span class="text-red-700 font-bold text-sm w-12 text-right">Evil</span>
          </div>
          <div class="flex justify-between text-sm mt-1">
            <span class="text-green-700 font-medium"><%= prediction[:good_win_pct] %>%</span>
            <% if @prediction_accuracy %>
              <span class="text-xs text-gray-500" title="Based on <%= @prediction_accuracy[:total] %> historical matches with <%= @prediction_accuracy[:bucket] %>% confidence">
                Historical: <span class="font-medium"><%= @prediction_accuracy[:accuracy] %>%</span> accurate
              </span>
            <% else %>
              <span class="text-xs text-gray-400">CR+ (improved for new players)</span>
            <% end %>
            <span class="text-red-700 font-medium"><%= prediction[:evil_win_pct] %>%</span>
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>Avg CR: <span class="text-green-600"><%= prediction[:good_details][:avg_cr] %></span> | Eff: <span class="text-green-600"><%= prediction[:good_details][:avg_effective_cr] %></span></span>
            <span>Avg CR: <span class="text-red-600"><%= prediction[:evil_details][:avg_cr] %></span> | Eff: <span class="text-red-600"><%= prediction[:evil_details][:avg_effective_cr] %></span></span>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>
