<% good_players = lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction&.good? } %>
<% evil_players = lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction && !lp.faction.good? } %>
<% good_with_players = good_players.select { |lp| lp.player.present? } %>
<% evil_with_players = evil_players.select { |lp| lp.player.present? } %>
<% good_avg_elo = good_with_players.any? ? (good_with_players.sum { |lp| lp.player.elo_rating.to_i } / good_with_players.size) : 0 %>
<% evil_avg_elo = evil_with_players.any? ? (evil_with_players.sum { |lp| lp.player.elo_rating.to_i } / evil_with_players.size) : 0 %>

<div id="<%= dom_id lobby %>" class="w-full sm:w-auto my-5 space-y-5">
  <table class="min-w-full divide-y divide-gray-200 border border-gray-300 rounded-lg shadow-sm">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faction</th>
        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ELO</th>
        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">W/L</th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      <tr class="bg-gray-100">
        <td colspan="4" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Forces of Middle Earth</td>
      </tr>
      <% good_players.each do |lp| %>
        <tr>
          <td class="px-4 py-2 whitespace-nowrap">
            <span style="display: inline-block; width: 16px; height: 16px; background-color: <%= lp.faction.color %>; border: 1px solid #000; vertical-align: middle; margin-right: 6px;"></span>
            <%= lp.faction.name %>
          </td>
          <td class="px-4 py-2 whitespace-nowrap"><%= lp.player&.nickname || "-" %></td>
          <td class="px-4 py-2 whitespace-nowrap"><%= lp.player&.elo_rating&.round || "-" %></td>
          <td class="px-4 py-2 whitespace-nowrap">
            <% if lp.player %>
              <span class="text-green-600"><%= lp.player.wins %>W</span>/<span class="text-red-600"><%= lp.player.losses %>L</span>
            <% else %>
              -
            <% end %>
          </td>
        </tr>
      <% end %>
      <tr class="bg-gray-50">
        <td class="px-4 py-2 font-bold">Average ELO</td>
        <td class="px-4 py-2"></td>
        <td class="px-4 py-2 font-bold"><%= good_avg_elo %></td>
        <td class="px-4 py-2"></td>
      </tr>
    </tbody>
    <tbody class="bg-white divide-y divide-gray-200">
      <tr class="bg-gray-100">
        <td colspan="4" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Forces of Sauron</td>
      </tr>
      <% evil_players.each do |lp| %>
        <tr>
          <td class="px-4 py-2 whitespace-nowrap">
            <span style="display: inline-block; width: 16px; height: 16px; background-color: <%= lp.faction.color %>; border: 1px solid #000; vertical-align: middle; margin-right: 6px;"></span>
            <%= lp.faction.name %>
          </td>
          <td class="px-4 py-2 whitespace-nowrap"><%= lp.player&.nickname || "-" %></td>
          <td class="px-4 py-2 whitespace-nowrap"><%= lp.player&.elo_rating&.round || "-" %></td>
          <td class="px-4 py-2 whitespace-nowrap">
            <% if lp.player %>
              <span class="text-green-600"><%= lp.player.wins %>W</span>/<span class="text-red-600"><%= lp.player.losses %>L</span>
            <% else %>
              -
            <% end %>
          </td>
        </tr>
      <% end %>
      <tr class="bg-gray-50">
        <td class="px-4 py-2 font-bold">Average ELO</td>
        <td class="px-4 py-2"></td>
        <td class="px-4 py-2 font-bold"><%= evil_avg_elo %></td>
        <td class="px-4 py-2"></td>
      </tr>
    </tbody>
    <% if lobby.observers.any? %>
      <tbody class="bg-white divide-y divide-gray-200">
        <tr class="bg-gray-100">
          <td colspan="4" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Observers</td>
        </tr>
        <% lobby.observers.each do |observer| %>
          <tr>
            <td class="px-4 py-2 whitespace-nowrap" colspan="2"><%= observer.nickname %></td>
            <td class="px-4 py-2 whitespace-nowrap"><%= observer.elo_rating&.round || "-" %></td>
            <td class="px-4 py-2 whitespace-nowrap">
              <span class="text-green-600"><%= observer.wins %>W</span>/<span class="text-red-600"><%= observer.losses %>L</span>
            </td>
          </tr>
        <% end %>
      </tbody>
    <% end %>
  </table>
</div>
