<% editable ||= false %>
<% good_players = lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction&.good? } %>
<% evil_players = lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction && !lp.faction.good? } %>
<% good_with_players = good_players.select { |lp| lp.player.present? } %>
<% evil_with_players = evil_players.select { |lp| lp.player.present? } %>
<% good_avg_elo = good_with_players.any? ? (good_with_players.sum { |lp| lp.player.elo_rating.to_i } / good_with_players.size) : 0 %>
<% evil_avg_elo = evil_with_players.any? ? (evil_with_players.sum { |lp| lp.player.elo_rating.to_i } / evil_with_players.size) : 0 %>
<% col_count = editable ? 4 : 6 %>

<div id="<%= dom_id lobby %>" class="w-full sm:w-auto my-5 space-y-5" data-controller="<%= 'auto-submit' if editable %>">
  <%= simple_form_for(lobby, data: editable ? { auto_submit_target: "form", turbo_action: "replace" } : {}) do |f| %>
    <% if editable %>
      <%= f.error_notification %>
      <%= f.error_notification message: f.object.errors[:base].to_sentence if f.object.errors[:base].present? %>
    <% end %>

    <table class="min-w-full divide-y divide-gray-200 border border-gray-300 rounded-lg shadow-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faction</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ELO</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">W/L</th>
          <% unless editable %>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">100d (any)</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">1y (faction)</th>
          <% end %>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" data-controller="average-elo">
        <tr class="bg-gray-100">
          <td colspan="<%= col_count %>" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Forces of Middle Earth</td>
        </tr>
        <%= render partial: "lobbies/lobby_player_row", collection: good_players, as: :lp, locals: { lobby: lobby, editable: editable, team_number: 1 } %>
        <tr class="bg-gray-50">
          <td class="px-4 py-2 font-bold">Average ELO</td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2 font-bold"><span data-average-elo-target="value"><%= good_avg_elo %></span></td>
          <td class="px-4 py-2" colspan="<%= col_count - 3 %>"></td>
        </tr>
      </tbody>
      <tbody class="bg-white divide-y divide-gray-200" data-controller="average-elo">
        <tr class="bg-gray-100">
          <td colspan="<%= col_count %>" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Forces of Sauron</td>
        </tr>
        <%= render partial: "lobbies/lobby_player_row", collection: evil_players, as: :lp, locals: { lobby: lobby, editable: editable, team_number: 2 } %>
        <tr class="bg-gray-50">
          <td class="px-4 py-2 font-bold">Average ELO</td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2 font-bold"><span data-average-elo-target="value"><%= evil_avg_elo %></span></td>
          <td class="px-4 py-2" colspan="<%= col_count - 3 %>"></td>
        </tr>
      </tbody>
      <% if lobby.observers.any? || editable %>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr class="bg-gray-100">
            <td colspan="<%= col_count %>" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Observers</td>
          </tr>
          <% if editable %>
            <tr>
              <td colspan="<%= col_count %>" class="px-4 py-2">
                <select name="lobby[observer_ids][]" multiple class="form-control w-full" data-controller="searchable-select" data-action="change->auto-submit#submit">
                  <% @players_for_select.each do |player| %>
                    <option value="<%= player.id %>" <%= "selected" if lobby.observer_ids.include?(player.id) %>>
                      <%= player.nickname %>
                    </option>
                  <% end %>
                </select>
                <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple observers</p>
              </td>
            </tr>
          <% else %>
            <% lobby.observers.each do |observer| %>
              <tr>
                <td class="px-4 py-2 whitespace-nowrap" colspan="2">
                  <%= link_to observer.nickname, player_path(observer), class: "text-blue-600 hover:underline" %>
                </td>
                <td class="px-4 py-2 whitespace-nowrap"><%= observer.elo_rating&.round || "-" %></td>
                <td class="px-4 py-2 whitespace-nowrap">
                  <span class="text-green-600"><%= observer.wins %>W</span>/<span class="text-red-600"><%= observer.losses %>L</span>
                </td>
                <td class="px-4 py-2 whitespace-nowrap">
                  <span class="text-green-600"><%= observer.recent_wins %>W</span>/<span class="text-red-600"><%= observer.recent_losses %>L</span>
                </td>
                <td class="px-4 py-2 whitespace-nowrap">-</td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      <% end %>
    </table>

    <%# Prediction bar %>
    <% if editable %>
      <div id="prediction" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Predicted Outcome</h3>
        <div class="flex items-center gap-2">
          <span class="text-green-700 font-medium">Good</span>
          <div class="flex-1 h-6 bg-gray-200 rounded-full overflow-hidden">
            <div id="good-win-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 50%"></div>
          </div>
          <span class="text-red-700 font-medium">Evil</span>
        </div>
        <div class="flex justify-between mt-1 text-sm">
          <span id="good-win-pct" class="text-green-700">50%</span>
          <span id="evil-win-pct" class="text-red-700">50%</span>
        </div>
      </div>

      <div class="form-actions mt-4 flex items-center gap-4">
        <span class="text-sm text-gray-500">Changes are saved automatically</span>
        <%= link_to "View Lobby", lobby, class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
      </div>
    <% elsif good_avg_elo > 0 && evil_avg_elo > 0 %>
      <% good_expected = 1.0 / (1 + 10 ** ((evil_avg_elo - good_avg_elo) / 400.0)) %>
      <% good_pct = (good_expected * 100).round %>
      <% evil_pct = 100 - good_pct %>
      <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Predicted Outcome</h3>
        <div class="flex items-center gap-2">
          <span class="text-green-700 font-medium">Good</span>
          <div class="flex-1 h-6 bg-red-500 rounded-full overflow-hidden">
            <div class="h-full bg-green-500" style="width: <%= good_pct %>%"></div>
          </div>
          <span class="text-red-700 font-medium">Evil</span>
        </div>
        <div class="flex justify-between mt-1 text-sm">
          <span class="text-green-700"><%= good_pct %>%</span>
          <span class="text-red-700"><%= evil_pct %>%</span>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
