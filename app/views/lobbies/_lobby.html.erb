<% editable ||= false %>
<% good_players = lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction&.good? } %>
<% evil_players = lobby.lobby_players.includes(:faction, :player).select { |lp| lp.faction && !lp.faction.good? } %>
<% good_with_players = good_players.select { |lp| lp.player.present? } %>
<% evil_with_players = evil_players.select { |lp| lp.player.present? } %>
<% good_avg_elo = good_with_players.any? ? (good_with_players.sum { |lp| lp.player.elo_rating.to_i } / good_with_players.size) : 0 %>
<% evil_avg_elo = evil_with_players.any? ? (evil_with_players.sum { |lp| lp.player.elo_rating.to_i } / evil_with_players.size) : 0 %>
<% good_avg_glicko = good_with_players.any? ? (good_with_players.sum { |lp| lp.player.glicko2_rating.to_f } / good_with_players.size) : 0 %>
<% evil_avg_glicko = evil_with_players.any? ? (evil_with_players.sum { |lp| lp.player.glicko2_rating.to_f } / evil_with_players.size) : 0 %>
<% good_rds = good_with_players.map { |lp| lp.player.glicko2_rating_deviation.to_f } %>
<% evil_rds = evil_with_players.map { |lp| lp.player.glicko2_rating_deviation.to_f } %>
<% good_pooled_rd = good_rds.any? ? Math.sqrt(good_rds.map { |r| r**2 }.sum / good_rds.size) : 350 %>
<% evil_pooled_rd = evil_rds.any? ? Math.sqrt(evil_rds.map { |r| r**2 }.sum / evil_rds.size) : 350 %>
<% good_avg_ml = good_with_players.any? ? (good_with_players.sum { |lp| lp.player.ml_score.to_f } / good_with_players.size).round(1) : 0 %>
<% evil_avg_ml = evil_with_players.any? ? (evil_with_players.sum { |lp| lp.player.ml_score.to_f } / evil_with_players.size).round(1) : 0 %>
<% good_avg_cr = good_with_players.any? ? (good_with_players.sum { |lp| lp.player.custom_rating.to_i } / good_with_players.size) : 0 %>
<% evil_avg_cr = evil_with_players.any? ? (evil_with_players.sum { |lp| lp.player.custom_rating.to_i } / evil_with_players.size) : 0 %>
<% col_count = editable ? 6 : 15 %>

<div id="<%= dom_id lobby %>" class="w-full sm:w-auto <%= editable ? 'mt-2 space-y-5' : 'my-5 space-y-5' %>" data-controller="<%= 'auto-submit' if editable %>">
  <%= simple_form_for(lobby, data: editable ? { auto_submit_target: "form", turbo_action: "replace" } : {}) do |f| %>
    <% if editable %>
      <%= f.error_notification %>
      <%= f.error_notification message: f.object.errors[:base].to_sentence if f.object.errors[:base].present? %>
    <% end %>

    <table class="min-w-full divide-y divide-gray-200 border border-gray-300 rounded-lg shadow-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faction</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
          <% if editable %>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="ML-based player score (0-100)">ML Score</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Custom rating">CR</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">W/L</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Win/Loss with this faction">Fac W/L</th>
          <% else %>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ELO</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Custom rating">CR</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Glicko-2 rating (uncertainty)">Glicko</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">W/L</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="ML-based player score (0-100)">ML Score</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Last game played">Last Played</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="1 year with this faction">1y Fac</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Average hero kill/death ratio">HK/D</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Hero uptime percentage">Hero Up</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Average hero kill contribution">HK%</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Average unit kill contribution">UK%</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Average team heal contribution">TH%</th>
          <% end %>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" data-controller="average-elo">
        <tr class="bg-gray-100">
          <td colspan="<%= col_count %>" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Forces of Middle Earth</td>
        </tr>
        <%= render partial: "lobbies/lobby_player_row", collection: good_players, as: :lp, locals: { lobby: lobby, editable: editable, team_number: 1, lobby_player_stats: @lobby_player_stats || {}, faction_specific_stats: @faction_specific_stats || {}, recent_stats: @recent_stats || {}, event_stats: @event_stats || {}, player_scores: @player_scores || {} } %>
        <tr class="bg-gray-50">
          <td class="px-4 py-2 font-bold text-sm">Average</td>
          <td class="px-4 py-2"></td>
          <% if editable %>
            <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="mlValue"><%= good_avg_ml %></span></td>
            <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="crValue"><%= good_avg_cr %></span></td>
            <td class="px-4 py-2"></td>
            <td class="px-4 py-2"></td>
          <% else %>
            <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="value"><%= good_avg_elo %></span></td>
            <td class="px-4 py-2 font-bold text-sm"><%= good_avg_cr %></td>
            <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="glickoValue"><%= good_avg_glicko.round %></span><span class="text-gray-400 text-xs">&plusmn;<span data-average-elo-target="glickoRd"><%= good_pooled_rd.round %></span></span></td>
            <% if col_count > 5 %><td class="px-4 py-2" colspan="<%= col_count - 5 %>"></td><% end %>
          <% end %>
        </tr>
      </tbody>
      <tbody class="bg-white divide-y divide-gray-200" data-controller="average-elo">
        <tr class="bg-gray-100">
          <td colspan="<%= col_count %>" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Forces of Sauron</td>
        </tr>
        <%= render partial: "lobbies/lobby_player_row", collection: evil_players, as: :lp, locals: { lobby: lobby, editable: editable, team_number: 2, lobby_player_stats: @lobby_player_stats || {}, faction_specific_stats: @faction_specific_stats || {}, recent_stats: @recent_stats || {}, event_stats: @event_stats || {}, player_scores: @player_scores || {} } %>
        <tr class="bg-gray-50">
          <td class="px-4 py-2 font-bold text-sm">Average</td>
          <td class="px-4 py-2"></td>
          <% if editable %>
            <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="mlValue"><%= evil_avg_ml %></span></td>
            <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="crValue"><%= evil_avg_cr %></span></td>
            <td class="px-4 py-2"></td>
            <td class="px-4 py-2"></td>
          <% else %>
            <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="value"><%= evil_avg_elo %></span></td>
            <td class="px-4 py-2 font-bold text-sm"><%= evil_avg_cr %></td>
            <td class="px-4 py-2 font-bold text-sm"><span data-average-elo-target="glickoValue"><%= evil_avg_glicko.round %></span><span class="text-gray-400 text-xs">&plusmn;<span data-average-elo-target="glickoRd"><%= evil_pooled_rd.round %></span></span></td>
            <% if col_count > 5 %><td class="px-4 py-2" colspan="<%= col_count - 5 %>"></td><% end %>
          <% end %>
        </tr>
      </tbody>
      <% if editable %>
        <%# Hidden select for form submission - managed by JS observers column %>
        <select name="lobby[observer_ids][]" multiple class="hidden" id="observer-select" data-action="change->auto-submit#submit">
          <% @players_for_select.each do |player| %>
            <option value="<%= player.id %>" <%= "selected" if lobby.observer_ids.include?(player.id) %>>
              <%= player.nickname %>
            </option>
          <% end %>
        </select>
      <% elsif lobby.observers.any? %>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr class="bg-gray-100">
            <td colspan="<%= col_count %>" class="px-4 py-2 text-left text-sm text-gray-500 font-medium">Observers</td>
          </tr>
          <% lobby.observers.each do |observer| %>
            <% obs_stats = @lobby_player_stats&.dig(observer.id) %>
            <% obs_recent = @recent_stats&.dig(observer.id) %>
            <% obs_event_stats = @event_stats&.dig(observer.id) %>
            <tr>
              <td class="px-4 py-2 whitespace-nowrap text-sm" colspan="2">
                <%= link_to observer.nickname, player_path(observer), class: "text-blue-600 hover:underline" %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm"><%= observer.elo_rating&.round || "-" %></td>
              <td class="px-4 py-2 whitespace-nowrap text-sm"><%= observer.custom_rating&.round || "-" %></td>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if observer.glicko2_rating %>
                  <%= observer.glicko2_rating.round %><span class="text-gray-400 text-xs">&plusmn;<%= observer.glicko2_rating_deviation&.round || "-" %></span>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if obs_stats %>
                  <span class="text-green-600"><%= obs_stats[:wins] %>W</span>/<span class="text-red-600"><%= obs_stats[:losses] %>L</span>
                <% else %>
                  -
                <% end %>
              </td>
              <%# Score %>
              <% obs_score_data = @player_scores&.dig(observer.id) %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if obs_score_data %>
                  <% obs_score = obs_score_data[:score] %>
                  <% obs_color_class = obs_score >= 55 ? 'text-green-600' : (obs_score <= 45 ? 'text-red-600' : 'text-gray-600') %>
                  <span class="<%= obs_color_class %> font-medium" title="Raw score: <%= obs_score_data[:raw_score] %>"><%= obs_score %></span>
                <% else %>
                  -
                <% end %>
              </td>
              <%# Last Played %>
              <td class="px-4 py-2 whitespace-nowrap text-sm" title="<%= observer.last_seen&.strftime('%Y-%m-%d') %>">
                <%= short_time_ago(observer.last_seen) %>
              </td>
              <%# 1y Fac - N/A for observers %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">-</td>
              <%# Hero K/D %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if obs_event_stats && obs_event_stats[:hero_kd_ratio] %>
                  <%= obs_event_stats[:hero_kd_ratio] %>
                <% else %>
                  -
                <% end %>
              </td>
              <%# Hero Uptime %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if obs_event_stats && obs_event_stats[:hero_uptime] %>
                  <%= obs_event_stats[:hero_uptime] %>%
                <% else %>
                  -
                <% end %>
              </td>
              <%# HK% %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if obs_stats %><%= obs_stats[:avg_hero_kill_contribution] %>%<% else %>-<% end %>
              </td>
              <%# UK% %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if obs_stats %><%= obs_stats[:avg_unit_kill_contribution] %>%<% else %>-<% end %>
              </td>
              <%# TH% %>
              <td class="px-4 py-2 whitespace-nowrap text-sm">
                <% if obs_stats && obs_stats[:avg_team_heal_contribution] > 0 %><%= obs_stats[:avg_team_heal_contribution] %>%<% else %>-<% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      <% end %>
    </table>

    <%# Prediction bar %>
    <% if editable %>
      <div id="prediction" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Predicted Outcome</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <div class="text-xs text-gray-500 mb-1">ML Score (avg: <span id="ml-good-avg" class="text-green-600">-</span> vs <span id="ml-evil-avg" class="text-red-600">-</span>)</div>
            <div class="flex items-center gap-2">
              <span class="text-green-700 font-medium text-sm">Good</span>
              <div class="flex-1 h-5 bg-red-500 rounded-full overflow-hidden">
                <div id="good-win-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 50%"></div>
              </div>
              <span class="text-red-700 font-medium text-sm">Evil</span>
            </div>
            <div class="flex justify-between text-xs">
              <span id="good-win-pct" class="text-green-700">50%</span>
              <span id="evil-win-pct" class="text-red-700">50%</span>
            </div>
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">Custom Rating (avg: <span id="cr-good-avg" class="text-green-600">-</span> vs <span id="cr-evil-avg" class="text-red-600">-</span>)</div>
            <div class="flex items-center gap-2">
              <span class="text-green-700 font-medium text-sm">Good</span>
              <div class="flex-1 h-5 bg-red-500 rounded-full overflow-hidden">
                <div id="cr-good-win-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 50%"></div>
              </div>
              <span class="text-red-700 font-medium text-sm">Evil</span>
            </div>
            <div class="flex justify-between text-xs">
              <span id="cr-good-win-pct" class="text-green-700">50%</span>
              <span id="cr-evil-win-pct" class="text-red-700">50%</span>
            </div>
          </div>
        </div>
      </div>
    <% elsif good_avg_elo > 0 && evil_avg_elo > 0 %>
      <% good_expected = 1.0 / (1 + 10 ** ((evil_avg_elo - good_avg_elo) / 400.0)) %>
      <% good_pct = (good_expected * 100).round %>
      <% evil_pct = 100 - good_pct %>
      <%# Glicko-2 prediction using g(phi) weighted expected score %>
      <% scale = 173.7178 %>
      <% mu_good = (good_avg_glicko - 1500) / scale %>
      <% mu_evil = (evil_avg_glicko - 1500) / scale %>
      <% phi_combined = Math.sqrt(good_pooled_rd**2 + evil_pooled_rd**2) / scale %>
      <% g_phi = 1.0 / Math.sqrt(1.0 + 3.0 * phi_combined**2 / Math::PI**2) %>
      <% glicko_good_expected = 1.0 / (1.0 + Math.exp(-g_phi * (mu_good - mu_evil))) %>
      <% glicko_good_pct = (glicko_good_expected * 100).round %>
      <% glicko_evil_pct = 100 - glicko_good_pct %>
      <%# Custom Rating prediction %>
      <% cr_good_expected = good_avg_cr > 0 && evil_avg_cr > 0 ? 1.0 / (1 + 10 ** ((evil_avg_cr - good_avg_cr) / 400.0)) : 0.5 %>
      <% cr_good_pct = (cr_good_expected * 100).round %>
      <% cr_evil_pct = 100 - cr_good_pct %>
      <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Predicted Outcome</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <div class="text-xs text-gray-500 mb-1">ELO (Good: <%= good_avg_elo %> vs Evil: <%= evil_avg_elo %>)</div>
            <div class="flex items-center gap-2">
              <span class="text-green-700 font-medium text-sm">Good</span>
              <div class="flex-1 h-5 bg-red-500 rounded-full overflow-hidden">
                <div class="h-full bg-green-500" style="width: <%= good_pct %>%"></div>
              </div>
              <span class="text-red-700 font-medium text-sm">Evil</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-green-700"><%= good_pct %>%</span>
              <span class="text-red-700"><%= evil_pct %>%</span>
            </div>
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">Custom (Good: <%= good_avg_cr %> vs Evil: <%= evil_avg_cr %>)</div>
            <div class="flex items-center gap-2">
              <span class="text-green-700 font-medium text-sm">Good</span>
              <div class="flex-1 h-5 bg-red-500 rounded-full overflow-hidden">
                <div class="h-full bg-green-500" style="width: <%= cr_good_pct %>%"></div>
              </div>
              <span class="text-red-700 font-medium text-sm">Evil</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-green-700"><%= cr_good_pct %>%</span>
              <span class="text-red-700"><%= cr_evil_pct %>%</span>
            </div>
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">Glicko-2 (Good: <%= good_avg_glicko.round %>&plusmn;<%= good_pooled_rd.round %> vs Evil: <%= evil_avg_glicko.round %>&plusmn;<%= evil_pooled_rd.round %>)</div>
            <div class="flex items-center gap-2">
              <span class="text-green-700 font-medium text-sm">Good</span>
              <div class="flex-1 h-5 bg-red-500 rounded-full overflow-hidden">
                <div class="h-full bg-green-500" style="width: <%= glicko_good_pct %>%"></div>
              </div>
              <span class="text-red-700 font-medium text-sm">Evil</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-green-700"><%= glicko_good_pct %>%</span>
              <span class="text-red-700"><%= glicko_evil_pct %>%</span>
            </div>
          </div>
          <% if @score_prediction %>
            <div>
              <%
                good_scores = lobby.lobby_players.select { |lp| lp.faction&.good? }.map do |lp|
                  if lp.player_id && @player_scores[lp.player_id]
                    @player_scores[lp.player_id][:score]
                  elsif lp.is_new_player?
                    40
                  end
                end.compact
                evil_scores = lobby.lobby_players.select { |lp| lp.faction && !lp.faction.good? }.map do |lp|
                  if lp.player_id && @player_scores[lp.player_id]
                    @player_scores[lp.player_id][:score]
                  elsif lp.is_new_player?
                    40
                  end
                end.compact
                good_avg = good_scores.any? ? (good_scores.sum / good_scores.size).round(1) : nil
                evil_avg = evil_scores.any? ? (evil_scores.sum / evil_scores.size).round(1) : nil
              %>
              <div class="text-xs text-gray-500 mb-1">
                ML Score
                <% if good_avg && evil_avg %>
                  <span class="text-gray-400" title="Average ML score per team">(avg: <span class="text-green-600"><%= good_avg %></span> vs <span class="text-red-600"><%= evil_avg %></span>)</span>
                <% end %>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-green-700 font-medium text-sm">Good</span>
                <div class="flex-1 h-5 bg-red-500 rounded-full overflow-hidden">
                  <div class="h-full bg-green-500" style="width: <%= @score_prediction[:good_win_pct] %>%"></div>
                </div>
                <span class="text-red-700 font-medium text-sm">Evil</span>
              </div>
              <div class="flex justify-between text-xs">
                <span class="text-green-700"><%= @score_prediction[:good_win_pct] %>%</span>
                <span class="text-red-700"><%= @score_prediction[:evil_win_pct] %>%</span>
              </div>
            </div>
          <% end %>
        </div>

        <%# Feature breakdown %>
        <% if @feature_contributions && @score_prediction %>
          <details class="mt-3">
            <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-700">Show ML score breakdown</summary>
            <div class="mt-2 text-xs">
              <table class="w-full">
                <thead>
                  <tr class="text-gray-500">
                    <th class="text-left py-1">Factor</th>
                    <th class="text-right py-1">Good</th>
                    <th class="text-right py-1">Evil</th>
                    <th class="text-right py-1">Diff</th>
                    <th class="text-right py-1">Weight</th>
                    <th class="text-right py-1">Impact</th>
                  </tr>
                </thead>
                <tbody>
                  <% factor_labels = { hero_kd: "Hero K/D", hero_kill_contribution: "HK%", unit_kill_contribution: "UK%", castle_raze_contribution: "CK%", team_heal_contribution: "TH%", games_played: "Games", elo: "ELO", enemy_elo_diff: "vs Enemy ELO" } %>
                  <% @feature_contributions.each do |key, data| %>
                    <tr class="border-t border-gray-100">
                      <td class="py-1"><%= factor_labels[key.to_sym] || key %></td>
                      <td class="text-right py-1 text-green-600"><%= data[:good_value] || "-" %></td>
                      <td class="text-right py-1 text-red-600"><%= data[:evil_value] || "-" %></td>
                      <td class="text-right py-1 <%= data[:difference].to_f > 0 ? 'text-green-600' : 'text-red-600' %>"><%= data[:difference]&.round(2) || "-" %></td>
                      <td class="text-right py-1 text-gray-500"><%= data[:weight]&.round(4) || "-" %></td>
                      <td class="text-right py-1 font-medium <%= data[:contribution].to_f > 0 ? 'text-green-600' : 'text-red-600' %>"><%= data[:contribution]&.round(3) || "-" %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </details>
        <% end %>
      </div>
    <% end %>
  <% end %>
</div>
