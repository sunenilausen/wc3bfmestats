<% index = lobby.lobby_players.index(lp) %>
<% player_stats = lobby_player_stats[lp.player_id] if lp.player_id %>
<% fac_stats = faction_specific_stats[lp.id] %>
<% player_recent = recent_stats[lp.player_id] if defined?(recent_stats) && lp.player_id %>
<% player_event_stats = event_stats[lp.player_id] if defined?(event_stats) && lp.player_id %>
<% player_score_data = player_scores[lp.player_id] if defined?(player_scores) && lp.player_id %>
<tr class="nested-fields" data-team="<%= team_number %>"
    <%= "data-lobby-drag-target=playerSlot data-slot-index=#{index}" if editable %>
    <%= "data-is-new-player=true" if editable && lp.is_new_player? %>>
  <td class="px-4 py-2 whitespace-nowrap text-sm">
    <span style="display: inline-block; width: 12px; height: 12px; background-color: <%= lp.faction.color_hex %>; border: 1px solid #000; vertical-align: middle; margin-right: 4px;"></span>
    <%= lp.faction.name %>
  </td>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="player-cell-<%= index %>">
    <% if editable %>
      <input type="hidden" name="lobby[lobby_players_attributes][<%= index %>][faction_id]" value="<%= lp.faction_id %>">
      <% if lp.persisted? %>
        <input type="hidden" name="lobby[lobby_players_attributes][<%= index %>][id]" value="<%= lp.id %>">
      <% end %>
      <input type="hidden" name="lobby[lobby_players_attributes][<%= index %>][is_new_player]" id="is-new-player-<%= index %>" value="<%= lp.is_new_player? ? '1' : '0' %>">
      <select name="lobby[lobby_players_attributes][<%= index %>][player_id]"
              class="hidden player-select"
              id="player-select-<%= index %>"
              data-average-elo-target="playerSelect"
              data-action="change->average-elo#calculateAverageElo"
              data-wl-target="wl-<%= index %>"
              data-faction-id="<%= lp.faction_id %>">
        <option value="" data-wins="" data-losses="">-- Select Player --</option>
        <% @players_for_select.each do |player| %>
          <% stats = @player_stats[player.id] || { wins: 0, losses: 0 } %>
          <% games = stats[:wins] + stats[:losses] %>
          <% player_data = @players_search_data_by_id&.dig(player.id) %>
          <option value="<%= player.id %>"
                  data-custom-rating="<%= player.custom_rating&.round || 1300 %>"
                  data-ml-score="<%= player.ml_score&.round || 50 %>"
                  data-avg-rank="<%= player_data&.dig(:avgRank)&.round(1) || 4.0 %>"
                  data-wins="<%= stats[:wins] %>"
                  data-losses="<%= stats[:losses] %>"
                  data-games="<%= games %>"
                  data-leave-pct="<%= player.leave_pct&.round || 0 %>"
                  data-games-left="<%= player.games_left || 0 %>"
                  <%= "selected" if player.id == lp.player_id %>>
            <%= player_display_name(player) %>
          </option>
        <% end %>
      </select>
      <% if lp.player %>
        <span class="slot-player cursor-move px-4 py-2 bg-blue-50 border border-blue-200 rounded inline-flex items-center gap-2"
              draggable="true"
              data-player-id="<%= lp.player_id %>"
              data-player-name="<%= player_display_name(lp.player) %>"
              data-slot-index="<%= index %>"
              ondragstart="handleSlotDragStart(event, <%= lp.player_id %>, '<%= j player_display_name(lp.player) %>', <%= index %>)"
              ondragend="handlePlayerDragEnd(event)">
          <%= player_display_name_html(lp.player) %>
          <% if lp.player.custom_rating_games_played.to_i < 30 %>
            <span class="text-xs bg-yellow-100 text-yellow-800 px-1 py-0.5 rounded">NEW</span>
          <% end %>
          <%= link_to player_path(lp.player), class: "text-gray-400 hover:text-blue-600", title: "View player", onclick: "event.stopPropagation()" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          <% end %>
          <button type="button" onclick="clearSlot(<%= index %>)" class="text-gray-400 hover:text-red-500 text-sm leading-none">&times;</button>
        </span>
      <% elsif lp.is_new_player? %>
        <span class="slot-player cursor-move px-2 py-1 bg-green-50 border border-green-300 rounded inline-flex items-center gap-2"
              draggable="true"
              data-player-id="new"
              data-player-name="New Player (<%= NewPlayerDefaults.ml_score %>)"
              data-slot-index="<%= index %>"
              data-is-new="true"
              data-ml-score="<%= NewPlayerDefaults.ml_score %>"
              ondragstart="handleSlotDragStart(event, 'new', 'New Player (<%= NewPlayerDefaults.ml_score %>)', <%= index %>)"
              ondragend="handlePlayerDragEnd(event)">
          <span class="text-green-700">New Player</span>
          <button type="button" onclick="clearSlot(<%= index %>)" class="text-gray-400 hover:text-red-500 text-sm leading-none">&times;</button>
        </span>
      <% else %>
        <span class="text-gray-400 italic">Empty slot</span>
      <% end %>
    <% elsif lp.player %>
      <%= link_to player_display_name_html(lp.player), player_path(lp.player), class: "text-blue-600 hover:underline" %>
      <% if lp.player.custom_rating_games_played.to_i < 30 %>
        <span class="text-xs bg-yellow-100 text-yellow-800 px-1 py-0.5 rounded ml-1">NEW</span>
      <% end %>
    <% elsif lp.is_new_player? %>
      <span class="text-green-700">New Player</span>
    <% else %>
      -
    <% end %>
  </td>
  <%# Leave % column %>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="leave-<%= index %>">
    <% if lp.player %>
      <% leave = lp.player.leave_pct %>
      <% if leave %>
        <span class="<%= leave == 0 ? 'text-green-600' : (leave >= 20 ? 'text-red-600' : 'text-yellow-600') %>">
          <%= leave.round %>%
        </span>
        <% if lp.player.games_left.to_i > 0 %>
          <span class="text-gray-400 text-xs">(<%= lp.player.games_left %>)</span>
        <% end %>
      <% else %>
        -
      <% end %>
    <% elsif lp.is_new_player? %>
      <span class="text-gray-400">-</span>
    <% else %>
      -
    <% end %>
  </td>
  <%# PERF column - performance score (overall/faction) %>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="ml-score-<%= index %>">
    <% if lp.player %>
      <% ml_score = lp.player.ml_score %>
      <% fac_perf = nil %>
      <% if editable && defined?(@faction_perf_stats) %>
        <% fac_perf = @faction_perf_stats[[lp.player_id, lp.faction_id]] %>
      <% elsif !editable && defined?(faction_perf_stats) %>
        <% fac_perf = faction_perf_stats[[lp.player_id, lp.faction_id]] %>
      <% end %>
      <span class="<%= ml_score_color_class(ml_score) %> font-medium"><%= format_perf_score(ml_score&.round) %></span><% if fac_perf %><span class="text-gray-400">/<%= format_perf_score(fac_perf) %></span><% end %>
    <% elsif lp.is_new_player? %>
      <span class="<%= ml_score_color_class(NewPlayerDefaults.ml_score) %> font-medium"><%= format_perf_score(NewPlayerDefaults.ml_score) %></span>
    <% else %>
      -
    <% end %>
  </td>
  <%# Custom Rating column %>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="cr-<%= index %>">
    <% if lp.player %>
      <%= lp.player.custom_rating&.round || "-" %>
    <% elsif lp.is_new_player? %>
      <%= NewPlayerDefaults.custom_rating %>
    <% else %>
      -
    <% end %>
  </td>
  <%# Overall W/L %>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="wl-<%= index %>">
    <% if lp.player %>
      <% if editable && @player_stats && @player_stats[lp.player_id] %>
        <% stats = @player_stats[lp.player_id] %>
        <span class="text-green-600"><%= stats[:wins] %></span>/<span class="text-red-600"><%= stats[:losses] %></span>
      <% elsif player_stats %>
        <span class="text-green-600"><%= player_stats[:wins] %></span>/<span class="text-red-600"><%= player_stats[:losses] %></span>
      <% else %>
        <span class="text-green-600"><%= lp.player.wins %></span>/<span class="text-red-600"><%= lp.player.losses %></span>
      <% end %>
    <% elsif lp.is_new_player? %>
      <span class="text-gray-400">0/0</span>
    <% else %>
      -
    <% end %>
  </td>
  <%# Faction W/L %>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="fac-wl-<%= index %>">
    <% if lp.player %>
      <% if editable && @faction_stats %>
        <% fac_wl = @faction_stats[[lp.player_id, lp.faction_id]] %>
        <% if fac_wl %>
          <span class="text-green-600"><%= fac_wl[:wins] %></span>/<span class="text-red-600"><%= fac_wl[:losses] %></span>
        <% else %>
          <span class="text-gray-400">0/0</span>
        <% end %>
      <% elsif defined?(faction_specific_stats) && fac_stats %>
        <span class="text-green-600"><%= fac_stats[:wins] || 0 %></span>/<span class="text-red-600"><%= fac_stats[:losses] || 0 %></span>
      <% else %>
        <span class="text-gray-400">0/0</span>
      <% end %>
    <% elsif lp.is_new_player? %>
      <span class="text-gray-400">0/0</span>
    <% else %>
      -
    <% end %>
  </td>
  <%# Combined Rank column - overall/faction rank %>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="rank-<%= index %>">
    <% if lp.player %>
      <%# Get overall avg rank %>
      <% if editable %>
        <% avg_rank_val = @players_search_data_by_id&.dig(lp.player_id, :avgRank) %>
        <% fac_data = @faction_rank_stats&.dig([lp.player_id, lp.faction_id]) %>
      <% else %>
        <% avg_rank_val = overall_avg_ranks[lp.player_id] if defined?(overall_avg_ranks) %>
        <% fac_data = faction_rank_data[[lp.player_id, lp.faction_id]] if defined?(faction_rank_data) %>
      <% end %>
      <% if avg_rank_val %>
        <% color_class = avg_rank_val <= 2.5 ? 'text-green-600' : (avg_rank_val >= 3.5 ? 'text-red-600' : '') %>
        <span class="<%= color_class %>"><%= avg_rank_val.round(1) %></span><% if fac_data %><span class="text-gray-400">/<%= fac_data[:avg].round(1) %></span><% end %>
      <% else %>
        <span class="text-gray-400">-</span>
      <% end %>
    <% elsif lp.is_new_player? %>
      <span class="text-gray-400">-</span>
    <% else %>
      -
    <% end %>
  </td>
  <% unless editable %>
    <%# Last Played %>
    <td class="px-4 py-2 whitespace-nowrap text-sm" title="<%= lp.player&.last_seen&.strftime('%Y-%m-%d') %>">
      <%= short_time_ago(lp.player&.last_seen) %>
    </td>
    <%# 1y faction %>
    <td class="px-4 py-2 whitespace-nowrap text-sm">
      <% faction_recent = player_recent&.dig(:faction_recent, lp.faction_id) %>
      <% if faction_recent %>
        <span class="text-green-600"><%= faction_recent[:wins] %></span>/<span class="text-red-600"><%= faction_recent[:losses] %></span>
      <% elsif lp.player && lp.faction %>
        <span class="text-green-600"><%= lp.player.recent_wins_with_faction(lp.faction, days: 365) %></span>/<span class="text-red-600"><%= lp.player.recent_losses_with_faction(lp.faction, days: 365) %></span>
      <% else %>
        -
      <% end %>
    </td>
  <% end %>
</tr>
