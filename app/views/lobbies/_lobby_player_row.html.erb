<% index = lobby.lobby_players.index(lp) %>
<% player_stats = lobby_player_stats[lp.player_id] if lp.player_id %>
<% fac_stats = faction_specific_stats[lp.id] %>
<% player_recent = recent_stats[lp.player_id] if defined?(recent_stats) && lp.player_id %>
<% player_event_stats = event_stats[lp.player_id] if defined?(event_stats) && lp.player_id %>
<tr class="nested-fields" data-team="<%= team_number %>"
    <%= "data-lobby-drag-target=playerSlot data-slot-index=#{index}" if editable %>>
  <td class="px-4 py-2 whitespace-nowrap text-sm">
    <span style="display: inline-block; width: 12px; height: 12px; background-color: <%= lp.faction.color_hex %>; border: 1px solid #000; vertical-align: middle; margin-right: 4px;"></span>
    <%= lp.faction.name %>
  </td>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="player-cell-<%= index %>">
    <% if editable %>
      <input type="hidden" name="lobby[lobby_players_attributes][<%= index %>][faction_id]" value="<%= lp.faction_id %>">
      <% if lp.persisted? %>
        <input type="hidden" name="lobby[lobby_players_attributes][<%= index %>][id]" value="<%= lp.id %>">
      <% end %>
      <select name="lobby[lobby_players_attributes][<%= index %>][player_id]"
              class="hidden player-select"
              id="player-select-<%= index %>"
              data-average-elo-target="playerSelect"
              data-action="change->average-elo#calculateAverageElo change->auto-submit#submit"
              data-wl-target="wl-<%= index %>">
        <option value="" data-wins="" data-losses="">-- Select Player --</option>
        <% @players_for_select.each do |player| %>
          <% stats = @player_stats[player.id] || { wins: 0, losses: 0 } %>
          <option value="<%= player.id %>"
                  data-elo="<%= player.elo_rating.round %>"
                  data-glicko="<%= player.glicko2_rating&.round || 1500 %>"
                  data-glicko-rd="<%= player.glicko2_rating_deviation&.round || 350 %>"
                  data-wins="<%= stats[:wins] %>"
                  data-losses="<%= stats[:losses] %>"
                  <%= "selected" if player.id == lp.player_id %>>
            <%= player.nickname %>
          </option>
        <% end %>
      </select>
      <% if lp.player %>
        <span class="slot-player cursor-move px-4 py-2 bg-blue-50 border border-blue-200 rounded inline-flex items-center gap-2"
              draggable="true"
              data-player-id="<%= lp.player_id %>"
              data-player-name="<%= lp.player.nickname %>"
              data-slot-index="<%= index %>"
              ondragstart="handleSlotDragStart(event, <%= lp.player_id %>, '<%= lp.player.nickname %>', <%= index %>)"
              ondragend="handlePlayerDragEnd(event)">
          <%= lp.player.nickname %>
          <button type="button" onclick="clearSlot(<%= index %>)" class="text-gray-400 hover:text-red-500 text-sm leading-none">&times;</button>
        </span>
      <% else %>
        <span class="text-gray-400 italic">Empty slot</span>
      <% end %>
    <% elsif lp.player %>
      <%= link_to lp.player.nickname, player_path(lp.player), class: "text-blue-600 hover:underline" %>
    <% else %>
      -
    <% end %>
  </td>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="elo-<%= index %>">
    <%= lp.player&.elo_rating&.round || "-" %>
  </td>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="glicko-<%= index %>">
    <% if lp.player&.glicko2_rating %>
      <%= lp.player.glicko2_rating.round %><span class="text-gray-400 text-xs">&plusmn;<%= lp.player.glicko2_rating_deviation&.round || "-" %></span>
    <% else %>
      -
    <% end %>
  </td>
  <td class="px-4 py-2 whitespace-nowrap text-sm" id="wl-<%= index %>">
    <% if lp.player %>
      <% if editable && @player_stats && @player_stats[lp.player_id] %>
        <% stats = @player_stats[lp.player_id] %>
        <span class="text-green-600"><%= stats[:wins] %>W</span>/<span class="text-red-600"><%= stats[:losses] %>L</span>
      <% elsif player_stats %>
        <span class="text-green-600"><%= player_stats[:wins] %>W</span>/<span class="text-red-600"><%= player_stats[:losses] %>L</span>
      <% else %>
        <span class="text-green-600"><%= lp.player.wins %>W</span>/<span class="text-red-600"><%= lp.player.losses %>L</span>
      <% end %>
    <% else %>
      -
    <% end %>
  </td>
  <% unless editable %>
    <%# Last Played %>
    <td class="px-4 py-2 whitespace-nowrap text-sm" title="<%= lp.player&.last_seen&.strftime('%Y-%m-%d') %>">
      <%= short_time_ago(lp.player&.last_seen) %>
    </td>
    <%# 1y faction %>
    <td class="px-4 py-2 whitespace-nowrap text-sm">
      <% faction_recent = player_recent&.dig(:faction_recent, lp.faction_id) %>
      <% if faction_recent %>
        <span class="text-green-600"><%= faction_recent[:wins] %></span>/<span class="text-red-600"><%= faction_recent[:losses] %></span>
      <% elsif lp.player && lp.faction %>
        <span class="text-green-600"><%= lp.player.recent_wins_with_faction(lp.faction, days: 365) %></span>/<span class="text-red-600"><%= lp.player.recent_losses_with_faction(lp.faction, days: 365) %></span>
      <% else %>
        -
      <% end %>
    </td>
    <%# Hero K/D %>
    <td class="px-4 py-2 whitespace-nowrap text-sm">
      <% if player_event_stats && player_event_stats[:hero_kd_ratio] %>
        <%= player_event_stats[:hero_kd_ratio] %>
      <% else %>
        -
      <% end %>
    </td>
    <%# Hero Uptime %>
    <td class="px-4 py-2 whitespace-nowrap text-sm">
      <% if player_event_stats && player_event_stats[:hero_uptime] %>
        <%= player_event_stats[:hero_uptime] %>%
      <% else %>
        -
      <% end %>
    </td>
    <%# Base Uptime %>
    <td class="px-4 py-2 whitespace-nowrap text-sm">
      <% if player_event_stats && player_event_stats[:base_uptime] %>
        <%= player_event_stats[:base_uptime] %>%
      <% else %>
        -
      <% end %>
    </td>
    <%# Avg HK% %>
    <td class="px-4 py-2 whitespace-nowrap text-sm">
      <% if player_stats %>
        <%= player_stats[:avg_hero_kill_contribution] %>%
      <% else %>
        -
      <% end %>
    </td>
    <%# Avg UK% %>
    <td class="px-4 py-2 whitespace-nowrap text-sm">
      <% if player_stats %>
        <%= player_stats[:avg_unit_kill_contribution] %>%
      <% else %>
        -
      <% end %>
    </td>
  <% end %>
</tr>
