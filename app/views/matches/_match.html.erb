<div id="<%= dom_id match %>" class="w-full my-5">
  <div>
    <strong class="inline font-medium">Uploaded:</strong>
    <%= match.uploaded_at&.strftime("%Y-%m-%d") || match.created_at.strftime("%Y-%m-%d") %>
    <% if match.seconds.present? && match.seconds > 0 %>
      <span class="text-gray-500">(<%= ChronicDuration.output(match.seconds, format: :short) %>)</span>
    <% end %>
    <% if match.ignored? %>
      <span class="ml-2 px-2 py-0.5 bg-red-100 text-red-700 text-sm rounded">Ignored</span>
    <% end %>
    <% if match.victory_overridden? %>
      <span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-sm rounded">Victory Overridden</span>
    <% end %>
  </div>

  <div class="mt-4">
    <div>
      <strong class="block font-medium mb-1">Appearances:</strong>
      <% good_appearances = match.appearances.select { |a| a.faction&.good? } %>
      <% evil_appearances = match.appearances.select { |a| a.faction && !a.faction.good? } %>
      <ul class="list-disc pl-5">
        <li class="font-semibold mb-2">Forces of Middle Earth (<%= match.good_victory ? "Victory" : "Defeat" %>) </li>
        <% if good_appearances.any? %>
          <div class="overflow-x-auto">
            <%= render partial: "matches/team_table", locals: { appearances: good_appearances, match: match } %>
          </div>
        <% else %>
          <p class="text-gray-500 italic ml-4">No players</p>
        <% end %>
        <li class="font-semibold mb-2">Forces of Sauron (<%= match.good_victory ? "Defeat" : "Victory" %>) </li>
        <% if evil_appearances.any? %>
          <div class="overflow-x-auto">
            <%= render partial: "matches/team_table", locals: { appearances: evil_appearances, match: match } %>
          </div>
        <% else %>
          <p class="text-gray-500 italic ml-4">No players</p>
        <% end %>
      </ul>
    </div>

    <% if match.wc3stats_replay&.chatlog&.any? || match.wc3stats_replay&.events&.any? %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
        <% if match.wc3stats_replay&.chatlog&.any? %>
          <div>
            <strong class="block font-medium mb-2">Chat History:</strong>
            <div class="bg-gray-50 rounded-md p-3 max-h-64 overflow-y-auto text-sm font-mono">
              <% match.wc3stats_replay.chatlog.each do |msg| %>
                <div class="mb-1">
                  <span class="text-gray-500"><%= ChronicDuration.output(msg["time"], format: :short) %></span>
                  <span class="font-semibold text-blue-700"><%= match.wc3stats_replay.player_name_by_id(msg["playerId"]) %>:</span>
                  <span><%= msg["message"] %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if match.wc3stats_replay&.events&.any? %>
          <div>
            <strong class="block font-medium mb-2">Event Log:</strong>
            <div class="bg-gray-50 rounded-md p-3 max-h-64 overflow-y-auto text-sm font-mono">
              <% match.wc3stats_replay.events.each do |event| %>
                <div class="mb-1">
                  <span class="text-gray-500"><%= ChronicDuration.output(event["time"], format: :short) %></span>
                  <span class="<%= event["eventName"] == "heroDeath" ? "text-red-600" : "text-orange-600" %>">
                    <%= event["eventName"] == "heroDeath" ? "Hero Death:" : "Base Destroyed:" %>
                  </span>
                  <span><%= match.wc3stats_replay.fix_encoding(event["args"]&.first&.gsub("\\", "")) %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="mt-6 pt-4 border-t border-gray-200">
    <div class="flex flex-wrap gap-x-6 gap-y-1 text-sm text-gray-500">
      <% if match.major_version.present? || match.build_version.present? %>
        <span>
          <strong>WC3:</strong>
          <%= match.major_version %><% if match.build_version.present? %> (build <%= match.build_version %>)<% end %>
        </span>
      <% end %>
      <% if match.map_version.present? %>
        <span><strong>Map:</strong> BFME <%= match.map_version %></span>
      <% end %>
      <% if match.wc3stats_replay&.wc3stats_replay_id.present? %>
        <span>
          <strong>Replay:</strong>
          <%= link_to "##{match.wc3stats_replay.wc3stats_replay_id}", "https://wc3stats.com/games/#{match.wc3stats_replay.wc3stats_replay_id}", target: "_blank", class: "text-blue-600 hover:underline" %>
        </span>
      <% end %>
      <% if match.row_order.present? %>
        <span><strong>Order:</strong> <%= match.row_order %></span>
      <% end %>
      <% if match.wc3stats_replay&.replay_hash.present? %>
        <span><strong>Checksum:</strong> <%= match.wc3stats_replay.replay_hash %></span>
      <% end %>
    </div>
  </div>
</div>
