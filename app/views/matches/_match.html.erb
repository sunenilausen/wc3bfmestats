<div id="<%= dom_id match %>" class="w-full my-5">
  <div>
    <strong class="inline font-medium">Uploaded:</strong>
    <%= match.uploaded_at&.strftime("%Y-%m-%d") || match.created_at.strftime("%Y-%m-%d") %>
    <% if match.seconds.present? && match.seconds > 0 %>
      <span class="text-gray-500">(<%= ChronicDuration.output(match.seconds, format: :short) %>)</span>
    <% end %>
    <% if match.ignored? %>
      <span class="ml-2 px-2 py-0.5 bg-red-100 text-red-700 text-sm rounded">Ignored</span>
    <% end %>
    <% if match.victory_overridden? %>
      <span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-sm rounded">Victory Overridden</span>
    <% end %>
  </div>

  <% if match.predicted_good_win_pct.present? %>
    <%
      good_pct = match.predicted_good_win_pct.to_f
      evil_pct = 100 - good_pct
      good_favored = good_pct >= 50
      prediction_correct = (good_favored && match.good_victory) || (!good_favored && !match.good_victory)

      # CR-only prediction calculated from appearance custom_rating (CR at time of match)
      good_crs = match.appearances.select { |a| a.faction&.good? }.filter_map(&:custom_rating)
      evil_crs = match.appearances.select { |a| a.faction && !a.faction.good? }.filter_map(&:custom_rating)
      if good_crs.any? && evil_crs.any?
        good_cr_avg = good_crs.sum / good_crs.size.to_f
        evil_cr_avg = evil_crs.sum / evil_crs.size.to_f
        cr_diff = good_cr_avg - evil_cr_avg
        cr_good_pct = (1.0 / (1 + Math.exp(-cr_diff / 150.0)) * 100).round(1)
        cr_evil_pct = 100 - cr_good_pct
        cr_good_favored = cr_good_pct >= 50
        cr_prediction_correct = (cr_good_favored && match.good_victory) || (!cr_good_favored && !match.good_victory)
      end
    %>
    <div class="mt-3 p-3 bg-gray-50 rounded-md inline-block">
      <div class="mb-1">
        <span class="text-sm font-medium text-gray-600">CR+ prediction:</span>
        <span class="ml-2 font-semibold <%= good_favored ? 'text-green-600' : 'text-red-600' %>">
          <%= good_favored ? 'Good' : 'Evil' %> <%= [good_pct, evil_pct].max.round(1) %>%
        </span>
        <% if match.good_victory != nil %>
          <span class="ml-1 text-sm <%= prediction_correct ? 'text-green-600' : 'text-red-600' %>">
            (<%= prediction_correct ? 'correct' : 'upset' %>)
          </span>
        <% end %>
      </div>
      <% if defined?(cr_good_pct) && cr_good_pct %>
        <div>
          <span class="text-sm font-medium text-gray-600">CR-only prediction:</span>
          <span class="ml-2 font-semibold <%= cr_good_favored ? 'text-green-600' : 'text-red-600' %>">
            <%= cr_good_favored ? 'Good' : 'Evil' %> <%= [cr_good_pct, cr_evil_pct].max.round(1) %>%
          </span>
          <% if match.good_victory != nil %>
            <span class="ml-1 text-sm <%= cr_prediction_correct ? 'text-green-600' : 'text-red-600' %>">
              (<%= cr_prediction_correct ? 'correct' : 'upset' %>)
            </span>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <div class="mt-4 flex flex-col xl:flex-row gap-6">
    <div class="flex-1 min-w-0">
      <strong class="block font-medium mb-1">Appearances:</strong>
      <% good_appearances = match.appearances.select { |a| a.faction&.good? }.sort_by { |a| a.faction_id } %>
      <% evil_appearances = match.appearances.select { |a| a.faction && !a.faction.good? }.sort_by { |a| a.faction_id } %>
      <ul class="list-disc pl-5">
        <li class="font-semibold mb-2">Forces of Middle Earth (<%= match.good_victory ? "Victory" : "Defeat" %>) </li>
        <% if good_appearances.any? %>
          <div class="overflow-x-auto">
            <%= render partial: "matches/team_table", locals: { appearances: good_appearances, match: match } %>
          </div>
        <% else %>
          <p class="text-gray-500 italic ml-4">No players</p>
        <% end %>
        <li class="font-semibold mb-2">Forces of Sauron (<%= match.good_victory ? "Defeat" : "Victory" %>) </li>
        <% if evil_appearances.any? %>
          <div class="overflow-x-auto">
            <%= render partial: "matches/team_table", locals: { appearances: evil_appearances, match: match } %>
          </div>
        <% else %>
          <p class="text-gray-500 italic ml-4">No players</p>
        <% end %>
      </ul>
    </div>

    <% if match.wc3stats_replay&.chatlog&.any? || match.wc3stats_replay&.events&.any? %>
      <div class="xl:w-80 flex-shrink-0 space-y-4">
        <% if match.wc3stats_replay&.chatlog&.any? %>
          <div>
            <strong class="block font-medium mb-2">Chat History:</strong>
            <div class="bg-gray-50 rounded-md p-3 max-h-64 overflow-y-auto text-sm font-mono">
              <% match.wc3stats_replay.chatlog.each do |msg| %>
                <div class="mb-1">
                  <span class="text-gray-500"><%= ChronicDuration.output(msg["time"], format: :short) %></span>
                  <span class="font-semibold text-blue-700"><%= match.wc3stats_replay.player_name_by_id(msg["playerId"]) %>:</span>
                  <span><%= msg["message"] %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if match.wc3stats_replay&.events&.any? %>
          <div>
            <strong class="block font-medium mb-2">Event Log:</strong>
            <div class="bg-gray-50 rounded-md p-3 max-h-64 overflow-y-auto text-sm font-mono">
              <% match.wc3stats_replay.events.each do |event| %>
                <div class="mb-1">
                  <span class="text-gray-500"><%= ChronicDuration.output(event["time"], format: :short) %></span>
                  <span class="<%= event["eventName"] == "heroDeath" ? "text-red-600" : "text-orange-600" %>">
                    <%= event["eventName"] == "heroDeath" ? "Hero Death:" : "Base Destroyed:" %>
                  </span>
                  <span><%= match.wc3stats_replay.fix_encoding(event["args"]&.first&.gsub("\\", "")) %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="mt-6 pt-4 border-t border-gray-200">
    <div class="flex flex-wrap gap-x-6 gap-y-1 text-sm text-gray-500">
      <% if match.major_version.present? || match.build_version.present? %>
        <span>
          <strong>WC3:</strong>
          <%= match.major_version %><% if match.build_version.present? %> (build <%= match.build_version %>)<% end %>
        </span>
      <% end %>
      <% if match.map_version.present? %>
        <span><strong>Map:</strong> BFME <%= match.map_version %></span>
      <% end %>
      <% if match.wc3stats_replay&.wc3stats_replay_id.present? %>
        <span>
          <strong>Replay:</strong>
          <%= link_to "##{match.wc3stats_replay.wc3stats_replay_id}", "https://wc3stats.com/games/#{match.wc3stats_replay.wc3stats_replay_id}", target: "_blank", class: "text-blue-600 hover:underline" %>
        </span>
      <% end %>
      <% if match.row_order.present? %>
        <span><strong>Order:</strong> <%= match.row_order %></span>
      <% end %>
      <% if match.wc3stats_replay&.replay_hash.present? %>
        <span><strong>Checksum:</strong> <%= match.wc3stats_replay.replay_hash %></span>
      <% end %>
    </div>
  </div>
</div>
