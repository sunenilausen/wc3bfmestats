<table class="min-w-full divide-y divide-gray-200 rounded-lg shadow overflow-hidden mb-4">
    <thead class="bg-gray-50">
        <tr>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" style="min-width: 200px;">Player</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Stay Percentage (how long player stayed in match)">Stay</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Actions Per Minute">APM</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Previous Games">Prev</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Overall/Faction Avg Rank at time of match (1=best, 5=worst)">Rank</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Overall/Faction Performance Score at time of match (0=average)">PERF</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Unit Kills">UK</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Hero Kills">HK</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Castles Razed">CK</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Heroes Lost">HL</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Hero Uptime %">HU%</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Bases Lost">BL</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Team Heal">TH</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Total Heal">Heal</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Contribution Rank and Bonus">Contrib</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Custom Rating">CR</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider" title="Custom Rating Change">+/-</th>
        </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-100">
        <% appearances.each do |appearance| %>
            <%= render partial: "matches/appearance_row", locals: { appearance: appearance, appearances: appearances } %>
        <% end %>
        <tr class="font-bold bg-gray-100">
            <td class="px-2 py-1">Total</td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"><%= sum_unit_kills(appearances) %></td>
            <td class="px-2 py-1"><%= sum_hero_kills(appearances) %></td>
            <td class="px-2 py-1"><%= sum_castles_razed(appearances) %></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"><%= sum_team_heal(appearances) %></td>
            <td class="px-2 py-1"><%= sum_total_heal(appearances) %></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
        </tr>
        <tr class="font-bold bg-gray-100">
            <td class="px-2 py-1">/min</td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"><%= per_minute_unit_kills(appearances) %></td>
            <td class="px-2 py-1"><%= per_minute_hero_kills(appearances) %></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
        </tr>
        <tr class="font-bold bg-gray-50">
            <td class="px-2 py-1">Avg</td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1">
              <% apms = appearances.map(&:apm).compact %>
              <%= apms.any? ? (apms.sum / apms.size.to_f).round : '-' %>
            </td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1">
              <%
                overall_ranks = appearances.map(&:overall_avg_rank).compact
                faction_ranks = appearances.map(&:faction_avg_rank).compact
                avg_overall = overall_ranks.any? ? (overall_ranks.sum / overall_ranks.size.to_f).round(1) : nil
                avg_faction = faction_ranks.any? ? (faction_ranks.sum / faction_ranks.size.to_f).round(1) : nil
              %>
              <% if avg_overall %>
                <span class="<%= avg_overall <= 2.5 ? 'text-green-600' : (avg_overall >= 3.5 ? 'text-red-600' : '') %>"><%= avg_overall %></span><% if avg_faction %><span class="text-gray-400 font-normal">/<%= avg_faction %></span><% end %>
              <% end %>
            </td>
            <td class="px-2 py-1">
              <%
                perf_scores = appearances.map(&:perf_score).compact
                faction_perfs = appearances.map(&:faction_perf_score).compact
                avg_perf = perf_scores.any? ? (perf_scores.sum / perf_scores.size.to_f).round : nil
                avg_fac_perf = faction_perfs.any? ? (faction_perfs.sum / faction_perfs.size.to_f).round : nil
              %>
              <% if avg_perf %>
                <span class="<%= avg_perf >= 5 ? 'text-green-600' : (avg_perf <= -5 ? 'text-red-600' : '') %>"><%= format_perf_score(avg_perf) %></span><% if avg_fac_perf %><span class="text-gray-400 font-normal">/<%= format_perf_score(avg_fac_perf) %></span><% end %>
              <% end %>
            </td>
            <td class="px-2 py-1"><%= avg_unit_kills(appearances) %></td>
            <td class="px-2 py-1"><%= avg_hero_kills(appearances) %></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"><%= avg_team_heal(appearances) %></td>
            <td class="px-2 py-1"><%= avg_total_heal(appearances) %></td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"><%= avg_custom_rating(appearances) %></td>
            <td class="px-2 py-1"></td>
        </tr>
    </tbody>
</table>
