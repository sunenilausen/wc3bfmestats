<%= turbo_frame_tag "match_history" do %>
  <% if appearances.any? %>
    <div class="overflow-x-auto">
      <table class="w-full text-sm border border-gray-200 rounded">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Played</th>
            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Faction</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase">Result</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Stay percentage - how long the player stayed in the game">Stay</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Contribution Rank (1=best)">Rank</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Hero Kills">HK</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Unit Kills">UK</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Heroes Lost">HL</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Bases Lost">BL</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Castles Razed">CK</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Base Kills (enemy main bases destroyed, 4.6+ only)">BK</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Custom rating change">CR+/-</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Custom rating after match">CR</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Actions Per Minute">APM</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase">Duration</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% appearances.each do |appearance| %>
            <% match = appearance.match %>
            <% faction = appearance.faction %>
            <% player_won = !match.is_draw? && ((faction.good? && match.good_victory?) || (!faction.good? && !match.good_victory?)) %>
            <%
              played_time = match.played_at || match.uploaded_at || match.created_at
              # Show time if not midnight (meaning we have actual time from filename)
              has_time = played_time.present? && (played_time.hour != 0 || played_time.min != 0)
              match_date = played_time&.strftime(has_time ? '%Y-%m-%d %H:%M' : '%Y-%m-%d') || 'Unknown'
              # Date is verified if played_at differs from uploaded_at (parsed from filename)
              date_verified = match.played_at.present? && match.uploaded_at.present? && match.played_at != match.uploaded_at
            %>
            <tr class="<%= match.is_draw? ? 'bg-gray-100' : (player_won ? 'bg-green-50' : 'bg-red-50') %>">
              <td class="px-2 py-1 whitespace-nowrap">
                <%= link_to match_date, match_path(match), class: "text-blue-600 hover:underline", data: { turbo_frame: "_top" } %><% if date_verified %><svg class="inline-block w-3.5 h-3.5 ml-1 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Verified from replay filename"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><% end %>
              </td>
              <td class="px-2 py-1 whitespace-nowrap">
                <span class="inline-flex items-center gap-1">
                  <span class="w-2.5 h-2.5 rounded-full" style="background-color: <%= faction.color_hex %>"></span>
                  <%= faction.name %>
                </span>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if match.is_draw? %>
                  <span class="text-gray-600 font-medium">Draw</span>
                <% elsif player_won %>
                  <span class="text-green-600 font-medium">Win</span>
                <% else %>
                  <span class="text-red-600 font-medium">Loss</span>
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.stay_pct.present? %>
                  <% if appearance.stay_pct >= 100 %>
                    <span class="text-green-600">100%</span>
                  <% elsif appearance.stay_pct >= 90 %>
                    <span class="text-yellow-600"><%= appearance.stay_pct.round %>%</span>
                  <% else %>
                    <span class="text-red-600"><%= appearance.stay_pct.round %>%</span>
                  <% end %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.contribution_rank %>
                  <span class="<%= appearance.contribution_rank <= 2 ? 'text-green-600' : (appearance.contribution_rank >= 4 ? 'text-red-600' : '') %>">#<%= appearance.contribution_rank %></span>
                  <% if appearance.is_mvp? %><span class="text-yellow-500" title="MVP: Top hero kills AND top unit kills">‚òÖ</span><% end %>
                  <% if appearance.has_ring_drop? %><span class="text-yellow-600" title="Ring Drop: Destroyed the One Ring (<%= appearance.has_ring_powered_drop? ? '+2, 2+ evil bases alive' : '+1' %>)">üíç</span><% end %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= appearance.hero_kills || '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= appearance.unit_kills || '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.heroes_lost && appearance.heroes_total %>
                  <%= appearance.heroes_lost %>/<%= appearance.heroes_total %>
                <% else %>
                  <%= heroes_lost_for_appearance(appearance) || '-' %>
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.bases_lost && appearance.bases_total %>
                  <%= appearance.bases_lost %>/<%= appearance.bases_total %>
                <% else %>
                  <%= bases_lost_for_appearance(appearance) || '-' %>
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= appearance.castles_razed || '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= match.map_version.to_s >= "4.6" ? (appearance.main_base_destroyed || 0) : '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.custom_rating_change %>
                  <% if appearance.custom_rating_change > 0 %>
                    <span class="text-green-600">+<%= appearance.custom_rating_change %></span>
                  <% elsif appearance.custom_rating_change < 0 %>
                    <span class="text-red-600"><%= appearance.custom_rating_change %></span>
                  <% else %>
                    <span class="text-gray-400">0</span>
                  <% end %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.custom_rating && appearance.custom_rating_change %>
                  <%= appearance.custom_rating + appearance.custom_rating_change %>
                <% elsif appearance.custom_rating %>
                  <%= appearance.custom_rating %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= appearance.apm || '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap text-gray-500">
                <% if match.seconds %>
                  <%= "#{match.seconds / 60}m" %>
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div>No matches found.</div>
  <% end %>
<% end %>
