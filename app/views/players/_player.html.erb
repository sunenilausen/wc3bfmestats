<div id="<%= dom_id player %>" class="w-full sm:w-auto my-5 space-y-5">
  <div class="mb-4 flex flex-wrap items-center gap-4">
    <%= link_to "Allies & Rivals", player_relationships_path(player), class: "rounded-md px-3.5 py-2.5 bg-blue-100 hover:bg-blue-50 text-blue-700 inline-block font-medium" %>

    <%= form_with url: player_path(player), method: :get, local: true, class: "flex flex-wrap items-center gap-4" do %>
      <div class="flex items-center gap-2">
        <label for="version_filter" class="text-sm text-gray-600">Stats:</label>
        <select name="version_filter" id="version_filter" onchange="this.form.submit()" class="rounded-md border border-gray-300 px-3 py-1.5 text-sm">
          <option value="">All versions</option>
          <option value="last:100" <%= "selected" if @version_filter == "last:100" %>>Last 100 games</option>
          <option value="last:50" <%= "selected" if @version_filter == "last:50" %>>Last 50 games</option>
          <% @available_map_versions.each do |version| %>
            <option value="from:<%= version %>" <%= "selected" if @version_filter == "from:#{version}" %>>from <%= version %></option>
          <% end %>
          <optgroup label="Single version">
            <% @available_map_versions.each do |version| %>
              <option value="only:<%= version %>" <%= "selected" if @version_filter == "only:#{version}" %>>only <%= version %></option>
            <% end %>
          </optgroup>
        </select>
      </div>
    <% end %>
  </div>

  <% if @last_n_games.present? && @last_n_games > 0 %>
    <div class="mb-4 px-3 py-2 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700">
      Showing stats for <strong>last <%= @last_n_games %> games</strong> (<%= stats[:total_matches] %> games)
      &mdash; <%= link_to "Show all games", player_path(player), class: "underline hover:no-underline" %>
    </div>
  <% elsif @map_version.present? %>
    <div class="mb-4 px-3 py-2 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700">
      Showing stats for <strong><%= @map_version %></strong> only (<%= stats[:total_matches] %> games)
      &mdash; <%= link_to "Show all versions", player_path(player), class: "underline hover:no-underline" %>
    </div>
  <% elsif @map_version_until.present? %>
    <div class="mb-4 px-3 py-2 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700">
      Showing stats from <strong><%= @map_version_until %></strong> onwards (<%= stats[:total_matches] %> games across <%= @filtered_map_versions.size %> versions)
      &mdash; <%= link_to "Show all versions", player_path(player), class: "underline hover:no-underline" %>
    </div>
  <% end %>
  <%# Compute Custom Rating extremes (after 20 placement wins) %>
  <%
    # appearances are in reverse chronological order, so reverse to get oldest first
    chronological_appearances = appearances.to_a.reverse
    win_count = 0
    post_placement_ratings = []
    chronological_appearances.each do |app|
      next unless app.custom_rating
      is_win = (app.faction.good? && app.match.good_victory?) || (!app.faction.good? && !app.match.good_victory?)
      win_count += 1 if is_win
      # Only include ratings after 20 wins (placement period)
      post_placement_ratings << app.custom_rating if win_count > 20
    end
    # Also include current rating if they have more than 20 wins
    post_placement_ratings << player.custom_rating.round if player.custom_rating && win_count > 20
    highest_custom = post_placement_ratings.any? ? post_placement_ratings.max : nil
    lowest_custom = post_placement_ratings.any? ? post_placement_ratings.min : nil

    # Use precomputed values from controller (efficient batch query)
    avg_enemy_team_cr = defined?(@avg_enemy_team_cr) ? @avg_enemy_team_cr : nil
    avg_team_cr = defined?(@avg_team_cr) ? @avg_team_cr : nil
  %>

  <%# Helper to convert percentile to bracket %>
  <%
    percentile_bracket = ->(pct) {
      case pct
      when 0..1 then "t1%"
      when 2..5 then "t5%"
      when 6..10 then "t10%"
      when 11..25 then "t25%"
      when 26..50 then "t50%"
      when 51..75 then "t75%"
      when 76..90 then "t90%"
      else "b10%"
      end
    }
  %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <%# Player Info %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Player Info</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Nickname</td>
            <td class="text-right py-0.5">
              <%= player.nickname %>
              <% if player.custom_rating_games_played.to_i < 30 %>
                <span class="text-xs bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded ml-1">NEW</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">Battletag</td>
            <td class="text-right py-0.5"><%= player.battletag %></td>
          </tr>
          <% if player.alternative_name.present? %>
            <tr>
              <td class="py-0.5">Also known as</td>
              <td class="text-right py-0.5"><%= player.alternative_name %></td>
            </tr>
          <% end %>
          <% if player.alternative_battletags.present? %>
            <tr>
              <td class="py-0.5">Alt Battletags</td>
              <td class="text-right py-0.5 text-gray-500 text-xs"><%= player.alternative_battletags.join(", ") %></td>
            </tr>
          <% end %>
          <tr>
            <td class="py-0.5">Region</td>
            <td class="text-right py-0.5"><%= player.region || "-" %></td>
          </tr>
          <% if player.games_left.to_i > 0 %>
            <tr>
              <td class="py-0.5" title="Number of games where player left before the match ended">Early Leaves</td>
              <td class="text-right py-0.5">
                <span class="text-red-600 font-medium"><%= player.games_left %></span>
                <span class="text-gray-500">(<%= player.leave_pct %>%)</span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <%# Rating & Score %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Rating & Score</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Custom Rating</td>
            <td class="text-right py-0.5">
              <span class="font-medium"><%= player.custom_rating&.round || "-" %></span>
              <% if local_assigns.key?(:ranks) && ranks && ranks[:cr_rank] && ranks[:cr_total] %>
                <% cr_percentile = (ranks[:cr_rank].to_f / ranks[:cr_total] * 100).round %>
                <span class="text-gray-500">(#<%= ranks[:cr_rank] %> - top<%= cr_percentile %>%)</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">Performance Score</td>
            <td class="text-right py-0.5">
              <%= tier_badge(player.ml_score) %>
              <span class="<%= ml_score_color_class(player.ml_score) %> font-medium"><%= format_perf_score(player.ml_score) %></span>
              <% if local_assigns.key?(:ranks) && ranks && ranks[:ml_rank] && ranks[:ml_total] %>
                <% ml_percentile = (ranks[:ml_rank].to_f / ranks[:ml_total] * 100).round %>
                <span class="text-gray-500">(#<%= ranks[:ml_rank] %> - top<%= ml_percentile %>%)</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">CR Range</td>
            <td class="text-right py-0.5"><%= lowest_custom || "-" %> - <%= highest_custom || "-" %></td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average Custom Rating of enemy teams faced">Avg Enemy CR</td>
            <td class="text-right py-0.5"><%= avg_enemy_team_cr || "-" %></td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average Custom Rating of teammates (excluding self)">Avg Team CR</td>
            <td class="text-right py-0.5"><%= avg_team_cr || "-" %></td>
          </tr>
          <% if player.custom_rating_bonus_wins.to_i > 0 %>
            <tr>
              <td class="py-0.5">Bonus Wins Left</td>
              <td class="text-right py-0.5">
                <span class="text-blue-600 font-medium">+<%= player.custom_rating_bonus_wins %></span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <%# Compute averages from preloaded appearances %>
  <% unit_kills_values = appearances.map(&:unit_kills).compact %>
  <% hero_kills_values = appearances.map(&:hero_kills).compact %>
  <% match_durations = appearances.map { |a| a.match.seconds }.compact %>
  <% avg_unit_kills = unit_kills_values.any? ? unit_kills_values.sum.to_f / unit_kills_values.size : 0 %>
  <% avg_hero_kills = hero_kills_values.any? ? hero_kills_values.sum.to_f / hero_kills_values.size : 0 %>
  <% avg_duration = match_durations.any? ? match_durations.sum.to_f / match_durations.size : 0 %>
  <% kills_per_min = avg_duration > 0 ? (avg_unit_kills / (avg_duration / 60.0)) : 0 %>
  <% hero_kills_per_min = avg_duration > 0 ? (avg_hero_kills / (avg_duration / 60.0)) : 0 %>

  <h2 class="text-2xl font-bold mb-3">Stats</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <%# Win/Loss Stats %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Record</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Overall</td>
            <td class="text-right py-0.5">
              <span class="text-green-600 font-medium"><%= stats[:wins] %>W</span>/<span class="text-red-600 font-medium"><%= stats[:losses] %>L</span>
              <% if stats[:total_matches] > 0 %>
                <span class="text-gray-500">(<%= number_with_precision(stats[:wins].to_f / stats[:total_matches] * 100, precision: 1) %>%)</span>
              <% end %>
            </td>
          </tr>
          <%
            good_games = stats[:wins_as_good] + stats[:losses_as_good]
            evil_games = stats[:wins_as_evil] + stats[:losses_as_evil]
            good_winrate = good_games > 0 ? (stats[:wins_as_good].to_f / good_games * 100).round(1) : 0
            evil_winrate = evil_games > 0 ? (stats[:wins_as_evil].to_f / evil_games * 100).round(1) : 0
            good_pct = stats[:total_matches] > 0 ? (good_games.to_f / stats[:total_matches] * 100).round(1) : 0
            evil_pct = stats[:total_matches] > 0 ? (evil_games.to_f / stats[:total_matches] * 100).round(1) : 0
          %>
          <tr>
            <td class="py-0.5">Good vs Evil</td>
            <td class="text-right py-0.5">
              <span class="font-medium"><%= good_games %></span> / <span class="font-medium"><%= evil_games %></span>
              <span class="text-gray-500">(<%= good_pct %>% / <%= evil_pct %>%)</span>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">As Good</td>
            <td class="text-right py-0.5">
              <span class="text-green-600 font-medium"><%= stats[:wins_as_good] %>W</span>/<span class="text-red-600 font-medium"><%= stats[:losses_as_good] %>L</span>
              <span class="text-gray-500">(<%= good_winrate %>%)</span>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">As Evil</td>
            <td class="text-right py-0.5">
              <span class="text-green-600 font-medium"><%= stats[:wins_as_evil] %>W</span>/<span class="text-red-600 font-medium"><%= stats[:losses_as_evil] %>L</span>
              <span class="text-gray-500">(<%= evil_winrate %>%)</span>
            </td>
          </tr>
          <%
            underdog_games = stats[:wins_as_underdog] + stats[:losses_as_underdog]
            favorite_games = stats[:wins_as_favorite] + stats[:losses_as_favorite]
            balanced_games = stats[:wins_as_balanced] + stats[:losses_as_balanced]
            total_role_games = underdog_games + favorite_games + balanced_games
            underdog_rate = total_role_games > 0 ? (underdog_games.to_f / total_role_games * 100).round(1) : 0
            favorite_rate = total_role_games > 0 ? (favorite_games.to_f / total_role_games * 100).round(1) : 0
            balanced_rate = total_role_games > 0 ? (balanced_games.to_f / total_role_games * 100).round(1) : 0
            underdog_winrate = underdog_games > 0 ? (stats[:wins_as_underdog].to_f / underdog_games * 100).round(1) : 0
            favorite_winrate = favorite_games > 0 ? (stats[:wins_as_favorite].to_f / favorite_games * 100).round(1) : 0
            balanced_winrate = balanced_games > 0 ? (stats[:wins_as_balanced].to_f / balanced_games * 100).round(1) : 0
          %>
          <tr>
            <td class="py-0.5" title="Percentage of games where team had <45% / 45-55% / >55% predicted win chance">Game Types</td>
            <td class="text-right py-0.5">
              <span class="text-purple-600 font-medium" title="Underdog (<45%)"><%= underdog_rate %>%</span> /
              <span class="text-teal-600 font-medium" title="Balanced (45-55%)"><%= balanced_rate %>%</span> /
              <span class="text-orange-600 font-medium" title="Favorite (>55%)"><%= favorite_rate %>%</span>
              <span class="text-gray-500 text-xs">(<%= total_role_games %> games)</span>
            </td>
          </tr>
          <tr>
            <td class="py-0.5" title="Win rate when team had <45% predicted win chance">As Underdog</td>
            <td class="text-right py-0.5">
              <span class="text-green-600 font-medium"><%= stats[:wins_as_underdog] %>W</span>/<span class="text-red-600 font-medium"><%= stats[:losses_as_underdog] %>L</span>
              <span class="text-purple-600 font-medium">(<%= underdog_winrate %>%)</span>
            </td>
          </tr>
          <tr>
            <td class="py-0.5" title="Win rate when team had 45-55% predicted win chance">As Balanced</td>
            <td class="text-right py-0.5">
              <span class="text-green-600 font-medium"><%= stats[:wins_as_balanced] %>W</span>/<span class="text-red-600 font-medium"><%= stats[:losses_as_balanced] %>L</span>
              <span class="text-teal-600 font-medium">(<%= balanced_winrate %>%)</span>
            </td>
          </tr>
          <tr>
            <td class="py-0.5" title="Win rate when team had >55% predicted win chance">As Favorite</td>
            <td class="text-right py-0.5">
              <span class="text-green-600 font-medium"><%= stats[:wins_as_favorite] %>W</span>/<span class="text-red-600 font-medium"><%= stats[:losses_as_favorite] %>L</span>
              <span class="text-orange-600 font-medium">(<%= favorite_winrate %>%)</span>
            </td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average difference between this player's CR and the enemy team's average CR. Positive means typically facing weaker opponents, negative means typically facing stronger opponents.">CR vs Enemies</td>
            <td class="text-right py-0.5">
              <% enemy_diff = stats[:avg_enemy_elo_diff] %>
              <% if enemy_diff > 0 %>
                <span class="text-green-600">+<%= enemy_diff %></span>
                <span class="text-gray-400 text-xs">(weaker foes)</span>
              <% elsif enemy_diff < 0 %>
                <span class="text-red-600"><%= enemy_diff %></span>
                <span class="text-gray-400 text-xs">(stronger foes)</span>
              <% else %>
                <span class="text-gray-500">0</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average difference between this player's CR and their teammates' average CR (excluding self). Positive means typically the strongest on the team, negative means typically with stronger teammates.">CR vs Teammates</td>
            <td class="text-right py-0.5">
              <% ally_diff = stats[:avg_ally_elo_diff] %>
              <% if ally_diff > 0 %>
                <span class="text-green-600">+<%= ally_diff %></span>
                <span class="text-gray-400 text-xs">(weaker teammates)</span>
              <% elsif ally_diff < 0 %>
                <span class="text-red-600"><%= ally_diff %></span>
                <span class="text-gray-400 text-xs">(stronger teammates)</span>
              <% else %>
                <span class="text-gray-500">0</span>
              <% end %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <%# Kill Stats %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Performance</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Top Hero Kills</td>
            <td class="text-right py-0.5">
              <%= number_with_precision(stats[:times_top_hero_kills], precision: 1) %>x
              <% if stats[:total_matches] > 0 %>
                <span class="text-gray-500">(<%= number_with_precision(stats[:times_top_hero_kills].to_f / stats[:total_matches] * 100, precision: 1) %>%)</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">Top Unit Kills</td>
            <td class="text-right py-0.5">
              <%= number_with_precision(stats[:times_top_unit_kills], precision: 1) %>x
              <% if stats[:total_matches] > 0 %>
                <span class="text-gray-500">(<%= number_with_precision(stats[:times_top_unit_kills].to_f / stats[:total_matches] * 100, precision: 1) %>%)</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5"><span class="text-yellow-500">‚òÖ</span> MVP</td>
            <td class="text-right py-0.5">
              <%= stats[:times_mvp] %>x
              <% if stats[:wins] > 0 %>
                <span class="text-gray-500">(<%= number_with_precision(stats[:times_mvp].to_f / stats[:wins] * 100, precision: 1) %>% of wins)</span>
              <% end %>
            </td>
          </tr>
          <% if stats[:times_ring_drop] && stats[:times_ring_drop] > 0 %>
            <tr>
              <td class="py-0.5"><span class="text-yellow-600">üíç</span> Ring Drop</td>
              <td class="text-right py-0.5">
                <%= stats[:times_ring_drop] %>x
              </td>
            </tr>
          <% end %>
          <tr>
            <td class="py-0.5">Avg Hero Kill Contrib</td>
            <td class="text-right py-0.5"><%= stats[:avg_hero_kill_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5">Avg Unit Kill Contrib</td>
            <td class="text-right py-0.5"><%= stats[:avg_unit_kill_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5">Avg Castle Raze Contrib</td>
            <td class="text-right py-0.5"><%= stats[:avg_castle_raze_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average share of team's base kills (4.6+ only)">Avg Base Kill Contrib</td>
            <td class="text-right py-0.5"><%= stats[:avg_main_base_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average share of team's total healing (self + teammates)">Avg Heal Contrib</td>
            <td class="text-right py-0.5"><%= stats[:avg_heal_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average share of team's healing applied to teammates (not self)">Avg Team Heal Contrib</td>
            <td class="text-right py-0.5"><%= stats[:avg_team_heal_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average contribution rank within team (1 = top performer, 5 = lowest)">Avg Contribution Rank</td>
            <td class="text-right py-0.5">
              <% rank = stats[:avg_contribution_rank] %>
              <% if rank && rank > 0 %>
                <span class="<%= rank <= 2 ? 'text-green-600' : (rank >= 4 ? 'text-red-600' : 'text-gray-600') %>">
                  #<%= rank %>
                </span>
              <% else %>
                -
              <% end %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <%# Average Kills %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Averages</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Hero Kills</td>
            <td class="text-right py-0.5"><%= number_with_precision(avg_hero_kills, precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5">Hero Kills/min</td>
            <td class="text-right py-0.5"><%= number_with_precision(hero_kills_per_min, precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5">Unit Kills</td>
            <td class="text-right py-0.5"><%= number_with_precision(avg_unit_kills, precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5">Unit Kills/min</td>
            <td class="text-right py-0.5"><%= number_with_precision(kills_per_min, precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5">Castles Razed</td>
            <td class="text-right py-0.5"><%= number_with_precision(stats[:avg_castles_razed], precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average base kills per game (4.6+ only)">Base Kills</td>
            <td class="text-right py-0.5"><%= number_with_precision(stats[:avg_main_base_destroyed], precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5" title="Actions Per Minute">APM</td>
            <td class="text-right py-0.5">
              <% apm_values = appearances.map(&:apm).compact %>
              <%= apm_values.any? ? number_with_precision(apm_values.sum / apm_values.size.to_f, precision: 1) : '-' %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <% if defined?(event_stats) && event_stats && event_stats[:total_games] > 0 %>
      <%# Hero Deaths %>
      <div class="bg-gray-50 rounded-md p-3">
        <h3 class="font-semibold mb-2 text-gray-700">Hero Losses</h3>
        <table class="w-full text-sm">
          <tbody>
            <tr>
              <td class="py-0.5">Hero K/D Ratio</td>
              <td class="text-right py-0.5">
                <% if event_stats[:hero_kd_ratio] %>
                  <%= event_stats[:hero_kills] %>/<%= event_stats[:hero_deaths] %>
                  <span class="text-gray-500">(<%= event_stats[:hero_kd_ratio] %>)</span>
                <% else %>
                  <%= event_stats[:hero_kills] %>/0
                <% end %>
              </td>
            </tr>
            <tr>
              <td class="py-0.5">Avg Heroes Survived</td>
              <td class="text-right py-0.5"><%= event_stats[:avg_heroes_survived] %> / <%= event_stats[:avg_heroes_total] %></td>
            </tr>
            <tr>
              <td class="py-0.5">Hero Uptime</td>
              <td class="text-right py-0.5"><%= event_stats[:hero_uptime] %>%</td>
            </tr>
            <tr>
              <td class="py-0.5">All Heroes Kept Alive</td>
              <td class="text-right py-0.5">
                <%= event_stats[:games_all_heroes_survived] %>/<%= event_stats[:games_with_hero_data] %>
                <span class="text-gray-500">(<%= event_stats[:all_heroes_survived_rate] %>%)</span>
              </td>
            </tr>
            <tr>
              <td class="py-0.5">All Heroes Lost</td>
              <td class="text-right py-0.5">
                <%= event_stats[:all_heroes_lost] %>x
                <span class="text-gray-500">(<%= event_stats[:all_heroes_lost_rate] %>%)</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <%# Base Deaths %>
      <div class="bg-gray-50 rounded-md p-3">
        <h3 class="font-semibold mb-2 text-gray-700">Base Losses</h3>
        <table class="w-full text-sm">
          <tbody>
            <tr>
              <td class="py-0.5">Avg Bases Survived</td>
              <td class="text-right py-0.5"><%= event_stats[:avg_bases_survived] %> / <%= event_stats[:avg_bases_total] %></td>
            </tr>
            <tr>
              <td class="py-0.5">Base Uptime</td>
              <td class="text-right py-0.5"><%= event_stats[:base_uptime] %>%</td>
            </tr>
            <tr>
              <td class="py-0.5">All Bases Kept Alive</td>
              <td class="text-right py-0.5">
                <%= event_stats[:games_all_bases_survived] %>/<%= event_stats[:games_with_bases] %>
                <span class="text-gray-500">(<%= event_stats[:all_bases_survived_rate] %>%)</span>
              </td>
            </tr>
            <tr>
              <td class="py-0.5">All Bases Lost</td>
              <td class="text-right py-0.5">
                <%= event_stats[:all_bases_lost] %>x
                <span class="text-gray-500">(<%= event_stats[:all_bases_lost_rate] %>%)</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>

  <% if stats[:faction_stats].any? %>
    <h2 class="text-2xl font-bold mb-3">Faction Stats</h2>

    <% good_factions = defined?(@good_factions) ? @good_factions : Faction.where(good: true).order(:id) %>
    <% evil_factions = defined?(@evil_factions) ? @evil_factions : Faction.where(good: false).order(:id) %>
    <% player_faction_stats = defined?(@player_faction_stats) ? @player_faction_stats : player.player_faction_stats.includes(:faction).index_by(&:faction_id) %>
    <% faction_totals = defined?(@faction_totals) ? @faction_totals : PlayerFactionStat.where.not(faction_score: nil).group(:faction_id).count %>

    <div class="space-y-6">
      <div>
        <h3 class="text-lg font-semibold text-green-700 mb-2">Good</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="text-left py-1">Faction</th>
                <th class="text-center py-1" title="Faction performance (0 = avg, positive = above avg)">F.Perf</th>
                <th class="text-center py-1" title="Faction-specific rating">F.Rating</th>
                <th class="text-center py-1" title="Percentage of games played with this faction">Play%</th>
                <th class="text-center py-1">W/L</th>
                <th class="text-center py-1">Win%</th>
                <th class="text-center py-1" title="Average Contribution Rank">Avg C.Rank</th>
                <th class="text-center py-1" title="Hero Uptime %">Hero Up</th>
                <th class="text-center py-1" title="Hero Kill Contribution %">HK%</th>
                <th class="text-center py-1" title="Unit Kill Contribution %">UK%</th>
                <th class="text-center py-1" title="Team Heal Contribution %">TH%</th>
                <th class="text-center py-1" title="Castle Raze Contribution %">CR%</th>
              </tr>
            </thead>
            <tbody>
              <% good_factions.each do |faction| %>
                <% fs = stats[:faction_stats][faction.id] %>
                <% next unless fs && fs[:games] > 0 %>
                <% efs = event_stats&.dig(:faction_stats, faction.id) %>
                <% pfs = player_faction_stats[faction.id] %>
                <% play_pct = stats[:total_matches] > 0 ? (fs[:games].to_f / stats[:total_matches] * 100).round(1) : 0 %>
                <tr class="border-b border-gray-100">
                  <td class="py-1">
                    <span class="inline-flex items-center gap-1.5">
                      <span class="w-2.5 h-2.5 rounded-full" style="background-color: <%= faction.color_hex %>"></span>
                      <%= link_to faction.name, faction_path(faction), class: "text-blue-600 hover:underline" %>
                    </span>
                  </td>
                  <td class="text-center py-1">
                    <% if pfs&.faction_score %>
                      <span class="<%= ml_score_color_class(pfs.faction_score) %> font-medium"><%= format_perf_score(pfs.faction_score.round(1)) %></span>
                      <% if pfs.rank %>
                        <% total = faction_totals[faction.id] || 0 %>
                        <% percentile = total > 0 ? (pfs.rank.to_f / total * 100).round : 0 %>
                        <span class="<%= pfs.rank <= 3 ? 'text-yellow-600 font-semibold' : (pfs.rank <= 10 ? 'text-green-600' : 'text-gray-400') %> text-xs">(#<%= pfs.rank %>, t<%= percentile %>%)</span>
                      <% end %>
                    <% else %>
                      <span class="text-gray-400">-</span>
                    <% end %>
                  </td>
                  <td class="text-center py-1">
                    <% if pfs&.faction_rating %>
                      <span class="font-medium"><%= pfs.faction_rating.to_i %></span>
                    <% else %>
                      <span class="text-gray-400">-</span>
                    <% end %>
                  </td>
                  <td class="text-center py-1 text-gray-500"><%= play_pct %>%</td>
                  <td class="text-center py-1">
                    <span class="text-green-600"><%= fs[:wins] %></span>/<span class="text-red-600"><%= fs[:losses] %></span>
                  </td>
                  <td class="text-center py-1"><%= fs[:win_rate] %>%</td>
                  <td class="text-center py-1">
                    <% fr = fs[:avg_contribution_rank] %>
                    <% if fr && fr > 0 %>
                      <span class="<%= fr <= 2 ? 'text-green-600' : (fr >= 4 ? 'text-red-600' : '') %>">#<%= fr %></span>
                    <% else %>
                      -
                    <% end %>
                  </td>
                  <td class="text-center py-1"><%= efs ? "#{efs[:hero_uptime]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_hero_kill_contribution] > 0 ? "#{fs[:avg_hero_kill_contribution]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_unit_kill_contribution] > 0 ? "#{fs[:avg_unit_kill_contribution]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_team_heal_contribution] > 0 ? "#{fs[:avg_team_heal_contribution]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_castle_raze_contribution] > 0 ? "#{fs[:avg_castle_raze_contribution]}%" : "-" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <h3 class="text-lg font-semibold text-red-700 mb-2">Evil</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="text-left py-1">Faction</th>
                <th class="text-center py-1" title="Faction performance (0 = avg, positive = above avg)">F.Perf</th>
                <th class="text-center py-1" title="Faction-specific rating">F.Rating</th>
                <th class="text-center py-1" title="Percentage of games played with this faction">Play%</th>
                <th class="text-center py-1">W/L</th>
                <th class="text-center py-1">Win%</th>
                <th class="text-center py-1" title="Average Contribution Rank">Avg C.Rank</th>
                <th class="text-center py-1" title="Hero Uptime %">Hero Up</th>
                <th class="text-center py-1" title="Hero Kill Contribution %">HK%</th>
                <th class="text-center py-1" title="Unit Kill Contribution %">UK%</th>
                <th class="text-center py-1" title="Team Heal Contribution %">TH%</th>
                <th class="text-center py-1" title="Castle Raze Contribution %">CR%</th>
              </tr>
            </thead>
            <tbody>
              <% evil_factions.each do |faction| %>
                <% fs = stats[:faction_stats][faction.id] %>
                <% next unless fs && fs[:games] > 0 %>
                <% efs = event_stats&.dig(:faction_stats, faction.id) %>
                <% pfs = player_faction_stats[faction.id] %>
                <% play_pct = stats[:total_matches] > 0 ? (fs[:games].to_f / stats[:total_matches] * 100).round(1) : 0 %>
                <tr class="border-b border-gray-100">
                  <td class="py-1">
                    <span class="inline-flex items-center gap-1.5">
                      <span class="w-2.5 h-2.5 rounded-full" style="background-color: <%= faction.color_hex %>"></span>
                      <%= link_to faction.name, faction_path(faction), class: "text-blue-600 hover:underline" %>
                    </span>
                  </td>
                  <td class="text-center py-1">
                    <% if pfs&.faction_score %>
                      <span class="<%= ml_score_color_class(pfs.faction_score) %> font-medium"><%= format_perf_score(pfs.faction_score.round(1)) %></span>
                      <% if pfs.rank %>
                        <% total = faction_totals[faction.id] || 0 %>
                        <% percentile = total > 0 ? (pfs.rank.to_f / total * 100).round : 0 %>
                        <span class="<%= pfs.rank <= 3 ? 'text-yellow-600 font-semibold' : (pfs.rank <= 10 ? 'text-green-600' : 'text-gray-400') %> text-xs">(#<%= pfs.rank %>, t<%= percentile %>%)</span>
                      <% end %>
                    <% else %>
                      <span class="text-gray-400">-</span>
                    <% end %>
                  </td>
                  <td class="text-center py-1">
                    <% if pfs&.faction_rating %>
                      <span class="font-medium"><%= pfs.faction_rating.to_i %></span>
                    <% else %>
                      <span class="text-gray-400">-</span>
                    <% end %>
                  </td>
                  <td class="text-center py-1 text-gray-500"><%= play_pct %>%</td>
                  <td class="text-center py-1">
                    <span class="text-green-600"><%= fs[:wins] %></span>/<span class="text-red-600"><%= fs[:losses] %></span>
                  </td>
                  <td class="text-center py-1"><%= fs[:win_rate] %>%</td>
                  <td class="text-center py-1">
                    <% fr = fs[:avg_contribution_rank] %>
                    <% if fr && fr > 0 %>
                      <span class="<%= fr <= 2 ? 'text-green-600' : (fr >= 4 ? 'text-red-600' : '') %>">#<%= fr %></span>
                    <% else %>
                      -
                    <% end %>
                  </td>
                  <td class="text-center py-1"><%= efs ? "#{efs[:hero_uptime]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_hero_kill_contribution] > 0 ? "#{fs[:avg_hero_kill_contribution]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_unit_kill_contribution] > 0 ? "#{fs[:avg_unit_kill_contribution]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_team_heal_contribution] > 0 ? "#{fs[:avg_team_heal_contribution]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_castle_raze_contribution] > 0 ? "#{fs[:avg_castle_raze_contribution]}%" : "-" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% else %>
    <div>No appearances recorded.</div>
  <% end %>

  <h2 class="text-2xl font-bold mb-3">Match History</h2>
  <%= turbo_frame_tag "match_history", src: match_history_player_path(player, version_filter: @version_filter), loading: :lazy do %>
    <div class="text-center py-8 text-gray-500">
      <span class="inline-block animate-spin mr-2">&#8635;</span>
      Loading match history...
    </div>
  <% end %>
</div>
