<div id="<%= dom_id player %>" class="w-full sm:w-auto my-5 space-y-5">
  <div>
    <strong class="block font-medium mb-1">Battletag:</strong>
    <%= player.battletag %>
  </div>
  <div>
    <strong class="block font-medium mb-1">Nickname:</strong>
    <%= player.nickname %>
  </div>
  <div>
    <strong class="block font-medium mb-1">Battlenet name:</strong>
    <%= player.battlenet_name %>
  </div>
  <div>
    <strong class="block font-medium mb-1">Elo rating:</strong>
    <%= player.elo_rating %>
  </div>
  <div>
    <strong class="block font-medium mb-1">Times observed:</strong>
    <%= player.observation_count %>
  </div>
  <div>
    <strong class="block font-medium mb-1">Region:</strong>
    <%= player.region %>
  </div>
  <div>
    <strong class="block font-medium mb-1">Battlenet number:</strong>
    <%= player.battlenet_number %>
  </div>

  <h2 class="text-2xl font-bold mb-3">Stats</h2>

  <div>
    <strong class="block font-medium mb-1">Record:</strong>
    <span class="text-green-600 font-medium"><%= player.wins %>W</span> / <span class="text-red-600 font-medium"><%= player.losses %>L</span>
    <% if player.matches.count > 0 %>
      <span class="text-gray-500">(<%= number_with_precision(player.wins.to_f / player.matches.count * 100, precision: 1) %>% win rate)</span>
    <% end %>
  </div>

  <div>
    <strong class="block font-medium mb-1">As Underdog:</strong>
    <span class="text-green-600 font-medium"><%= player.wins_as_underdog %>W</span> / <span class="text-red-600 font-medium"><%= player.losses_as_underdog %>L</span>
    <span class="text-gray-500">(avg <%= player.avg_underdog_elo_difference %> ELO deficit)</span>
  </div>

  <div>
    <strong class="block font-medium mb-1">As Favorite:</strong>
    <span class="text-green-600 font-medium"><%= player.wins_as_favorite %>W</span> / <span class="text-red-600 font-medium"><%= player.losses_as_favorite %>L</span>
    <span class="text-gray-500">(avg <%= player.avg_favorite_elo_difference %> ELO advantage)</span>
  </div>

  <% most_played = player.appearances.group(:faction).order('count_id DESC').limit(5).count(:id) %>
  <% if most_played.any? %>
    <div>
      <strong class="block font-medium mb-1">Top Factions:</strong>
      <ul class="list-disc ml-5">
        <% most_played.each do |faction, count| %>
          <li>
            <%= faction.name %> -
            <span class="text-green-600"><%= player.wins_with_faction(faction) %>W</span>/<span class="text-red-600"><%= player.losses_with_faction(faction) %>L</span>
            <span class="text-gray-500">(<%= player.win_rate_with_faction(faction) %>% win rate, <%= count %> matches)</span>
          </li>
        <% end %>
      </ul>
    </div>
  <% else %>
    <div>No appearances recorded.</div>
  <% end %>

  <div>
    <strong class="block font-medium mb-1">Average Unit Kills:</strong>
    <%= number_with_precision(player.appearances.average(:unit_kills) || 0, precision: 2) %>
  </div>

  <div>
    <strong class="block font-medium mb-1">Average Unit Kills per Minute:</strong>
    <% avg_kills = player.appearances.average(:unit_kills) || 0 %>
    <% avg_duration = player.matches.average(:seconds) || 0 %>
    <% kills_per_min = avg_duration > 0 ? (avg_kills / (avg_duration / 60.0)) : 0 %>
    <%= number_with_precision(kills_per_min, precision: 2) %>
  </div>

  <div>
    <strong class="block font-medium mb-1">Average Hero Kills:</strong>
    <%= number_with_precision(player.appearances.average(:hero_kills) || 0, precision: 2) %>
  </div>

  <div>
    <strong class="block font-medium mb-1">Average Hero Kills per Minute:</strong>
    <% avg_hero_kills = player.appearances.average(:hero_kills) || 0 %>
    <% hero_kills_per_min = avg_duration > 0 ? (avg_hero_kills / (avg_duration / 60.0)) : 0 %>
    <%= number_with_precision(hero_kills_per_min, precision: 2) %>
  </div>

  <h2 class="text-2xl font-bold mb-3">Appearances</h2>
  <% last_appearances = player.appearances.joins(:match).order(Arel.sql('COALESCE(matches.played_at, matches.created_at) DESC')) %>
  <% if last_appearances.any? %>
    <ul class="list-disc ml-5">
      <% last_appearances.each do |appearance| %>
        <li>
          <% match_date = (appearance.match.played_at || appearance.match.created_at).strftime('%Y-%m-%d') %>
          <%= link_to "Match ##{appearance.match.id} (#{match_date})", match_path(appearance.match), class: "text-blue-600 hover:underline" %>
        </li>
      <% end %>
    </ul>
  <% else %>
    <div>No appearances found.</div>
  <% end %>
</div>
