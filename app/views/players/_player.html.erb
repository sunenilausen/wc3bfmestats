<div id="<%= dom_id player %>" class="w-full sm:w-auto my-5 space-y-5">
  <%# Compute ELO extremes from preloaded appearances (include current ELO) %>
  <% elo_ratings = appearances.map(&:elo_rating).compact %>
  <% elo_ratings << player.elo_rating.round if player.elo_rating %>
  <% highest_elo = elo_ratings.any? ? elo_ratings.max : nil %>
  <% lowest_elo = elo_ratings.any? ? elo_ratings.min : nil %>

  <%# Compute Glicko-2 extremes %>
  <% glicko_ratings = appearances.map(&:glicko2_rating).compact %>
  <% glicko_ratings << player.glicko2_rating if player.glicko2_rating %>
  <% highest_glicko = glicko_ratings.any? ? glicko_ratings.max.round : nil %>
  <% lowest_glicko = glicko_ratings.any? ? glicko_ratings.min.round : nil %>

  <%# Player Info %>
  <div class="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-2 text-sm">
    <div><strong>Battletag:</strong> <%= player.battletag %></div>
    <div><strong>Nickname:</strong> <%= player.nickname %></div>
    <div><strong>Battlenet:</strong> <%= player.battlenet_name %></div>
    <div><strong>ELO:</strong> <%= player.elo_rating&.round || "-" %></div>
    <div><strong>Glicko-2:</strong> <%= player.glicko2_rating&.round || "-" %> <span class="text-gray-400 text-xs" title="Rating Deviation (uncertainty)">&plusmn;<%= player.glicko2_rating_deviation&.round || "-" %></span></div>
    <div><strong>ML Score:</strong> <span class="<%= ml_score_color_class(player.ml_score) %> font-medium"><%= player.ml_score %></span> <%= tier_badge(player.ml_score) %></div>
    <div><strong>Region:</strong> <%= player.region %></div>
    <div><strong>Highest ELO:</strong> <%= highest_elo || "-" %></div>
    <div><strong>Lowest ELO:</strong> <%= lowest_elo || "-" %></div>
    <div><strong>Highest Glicko:</strong> <%= highest_glicko || "-" %></div>
    <div><strong>Lowest Glicko:</strong> <%= lowest_glicko || "-" %></div>
  </div>

  <%# Compute averages from preloaded appearances %>
  <% unit_kills_values = appearances.map(&:unit_kills).compact %>
  <% hero_kills_values = appearances.map(&:hero_kills).compact %>
  <% match_durations = appearances.map { |a| a.match.seconds }.compact %>
  <% avg_unit_kills = unit_kills_values.any? ? unit_kills_values.sum.to_f / unit_kills_values.size : 0 %>
  <% avg_hero_kills = hero_kills_values.any? ? hero_kills_values.sum.to_f / hero_kills_values.size : 0 %>
  <% avg_duration = match_durations.any? ? match_durations.sum.to_f / match_durations.size : 0 %>
  <% kills_per_min = avg_duration > 0 ? (avg_unit_kills / (avg_duration / 60.0)) : 0 %>
  <% hero_kills_per_min = avg_duration > 0 ? (avg_hero_kills / (avg_duration / 60.0)) : 0 %>

  <h2 class="text-2xl font-bold mb-3">Stats</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <%# Win/Loss Stats %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Record</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Overall</td>
            <td class="text-right py-0.5">
              <span class="text-green-600 font-medium"><%= stats[:wins] %>W</span>/<span class="text-red-600 font-medium"><%= stats[:losses] %>L</span>
              <% if stats[:total_matches] > 0 %>
                <span class="text-gray-500">(<%= number_with_precision(stats[:wins].to_f / stats[:total_matches] * 100, precision: 1) %>%)</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">As Underdog</td>
            <td class="text-right py-0.5">
              <span class="text-green-600 font-medium"><%= stats[:wins_as_underdog] %>W</span>/<span class="text-red-600 font-medium"><%= stats[:losses_as_underdog] %>L</span>
              <span class="text-gray-500">(avg <%= stats[:avg_underdog_elo_diff] %> deficit)</span>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">As Favorite</td>
            <td class="text-right py-0.5">
              <span class="text-green-600 font-medium"><%= stats[:wins_as_favorite] %>W</span>/<span class="text-red-600 font-medium"><%= stats[:losses_as_favorite] %>L</span>
              <span class="text-gray-500">(avg <%= stats[:avg_favorite_elo_diff] %> adv)</span>
            </td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average difference between this player's ELO and the enemy team's average ELO. Positive means typically facing weaker opponents, negative means typically facing stronger opponents.">ELO vs Enemies</td>
            <td class="text-right py-0.5">
              <% enemy_diff = stats[:avg_enemy_elo_diff] %>
              <% if enemy_diff > 0 %>
                <span class="text-green-600">+<%= enemy_diff %></span>
                <span class="text-gray-400 text-xs">(weaker foes)</span>
              <% elsif enemy_diff < 0 %>
                <span class="text-red-600"><%= enemy_diff %></span>
                <span class="text-gray-400 text-xs">(stronger foes)</span>
              <% else %>
                <span class="text-gray-500">0</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5" title="Average difference between this player's ELO and their teammates' average ELO (excluding self). Positive means typically the strongest on the team, negative means typically carried by stronger teammates.">ELO vs Teammates</td>
            <td class="text-right py-0.5">
              <% ally_diff = stats[:avg_ally_elo_diff] %>
              <% if ally_diff > 0 %>
                <span class="text-green-600">+<%= ally_diff %></span>
                <span class="text-gray-400 text-xs">(team carry)</span>
              <% elsif ally_diff < 0 %>
                <span class="text-red-600"><%= ally_diff %></span>
                <span class="text-gray-400 text-xs">(carried)</span>
              <% else %>
                <span class="text-gray-500">0</span>
              <% end %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <%# Kill Stats %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Performance</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Top Hero Kills</td>
            <td class="text-right py-0.5">
              <%= number_with_precision(stats[:times_top_hero_kills], precision: 1) %>x
              <% if stats[:total_matches] > 0 %>
                <span class="text-gray-500">(<%= number_with_precision(stats[:times_top_hero_kills].to_f / stats[:total_matches] * 100, precision: 1) %>%)</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">Top Unit Kills</td>
            <td class="text-right py-0.5">
              <%= number_with_precision(stats[:times_top_unit_kills], precision: 1) %>x
              <% if stats[:total_matches] > 0 %>
                <span class="text-gray-500">(<%= number_with_precision(stats[:times_top_unit_kills].to_f / stats[:total_matches] * 100, precision: 1) %>%)</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td class="py-0.5">Avg Hero Kill Contrib</td>
            <td class="text-right py-0.5"><%= stats[:avg_hero_kill_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5">Avg Unit Kill Contrib</td>
            <td class="text-right py-0.5"><%= stats[:avg_unit_kill_contribution] %>%</td>
          </tr>
          <tr>
            <td class="py-0.5">Avg Castle Raze Contrib</td>
            <td class="text-right py-0.5"><%= stats[:avg_castle_raze_contribution] %>%</td>
          </tr>
        </tbody>
      </table>
    </div>

    <%# Average Kills %>
    <div class="bg-gray-50 rounded-md p-3">
      <h3 class="font-semibold mb-2 text-gray-700">Averages</h3>
      <table class="w-full text-sm">
        <tbody>
          <tr>
            <td class="py-0.5">Hero Kills</td>
            <td class="text-right py-0.5"><%= number_with_precision(avg_hero_kills, precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5">Hero Kills/min</td>
            <td class="text-right py-0.5"><%= number_with_precision(hero_kills_per_min, precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5">Unit Kills</td>
            <td class="text-right py-0.5"><%= number_with_precision(avg_unit_kills, precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5">Unit Kills/min</td>
            <td class="text-right py-0.5"><%= number_with_precision(kills_per_min, precision: 2) %></td>
          </tr>
          <tr>
            <td class="py-0.5">Castles Razed</td>
            <td class="text-right py-0.5"><%= number_with_precision(stats[:avg_castles_razed], precision: 2) %></td>
          </tr>
        </tbody>
      </table>
    </div>

    <% if defined?(event_stats) && event_stats && event_stats[:total_games] > 0 %>
      <%# Hero Deaths %>
      <div class="bg-gray-50 rounded-md p-3">
        <h3 class="font-semibold mb-2 text-gray-700">Hero Losses</h3>
        <table class="w-full text-sm">
          <tbody>
            <tr>
              <td class="py-0.5">Hero K/D Ratio</td>
              <td class="text-right py-0.5">
                <% if event_stats[:hero_kd_ratio] %>
                  <%= event_stats[:hero_kills] %>/<%= event_stats[:hero_deaths] %>
                  <span class="text-gray-500">(<%= event_stats[:hero_kd_ratio] %>)</span>
                <% else %>
                  <%= event_stats[:hero_kills] %>/0
                <% end %>
              </td>
            </tr>
            <tr>
              <td class="py-0.5">Avg Heroes Survived</td>
              <td class="text-right py-0.5"><%= event_stats[:avg_heroes_survived] %> / <%= event_stats[:avg_heroes_total] %></td>
            </tr>
            <tr>
              <td class="py-0.5">Hero Uptime</td>
              <td class="text-right py-0.5"><%= event_stats[:hero_uptime] %>%</td>
            </tr>
            <tr>
              <td class="py-0.5">All Heroes Kept Alive</td>
              <td class="text-right py-0.5">
                <%= event_stats[:games_all_heroes_survived] %>/<%= event_stats[:games_with_hero_data] %>
                <span class="text-gray-500">(<%= event_stats[:all_heroes_survived_rate] %>%)</span>
              </td>
            </tr>
            <tr>
              <td class="py-0.5">All Heroes Lost</td>
              <td class="text-right py-0.5">
                <%= event_stats[:all_heroes_lost] %>x
                <span class="text-gray-500">(<%= event_stats[:all_heroes_lost_rate] %>%)</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <%# Base Deaths %>
      <div class="bg-gray-50 rounded-md p-3">
        <h3 class="font-semibold mb-2 text-gray-700">Base Losses</h3>
        <table class="w-full text-sm">
          <tbody>
            <tr>
              <td class="py-0.5">Avg Bases Survived</td>
              <td class="text-right py-0.5"><%= event_stats[:avg_bases_survived] %> / <%= event_stats[:avg_bases_total] %></td>
            </tr>
            <tr>
              <td class="py-0.5">Base Uptime</td>
              <td class="text-right py-0.5"><%= event_stats[:base_uptime] %>%</td>
            </tr>
            <tr>
              <td class="py-0.5">All Bases Kept Alive</td>
              <td class="text-right py-0.5">
                <%= event_stats[:games_all_bases_survived] %>/<%= event_stats[:games_with_bases] %>
                <span class="text-gray-500">(<%= event_stats[:all_bases_survived_rate] %>%)</span>
              </td>
            </tr>
            <tr>
              <td class="py-0.5">All Bases Lost</td>
              <td class="text-right py-0.5">
                <%= event_stats[:all_bases_lost] %>x
                <span class="text-gray-500">(<%= event_stats[:all_bases_lost_rate] %>%)</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>

  <% if stats[:faction_stats].any? %>
    <h2 class="text-2xl font-bold mb-3">Faction Stats</h2>

    <% good_factions = Faction.where(good: true).order(:id) %>
    <% evil_factions = Faction.where(good: false).order(:id) %>

    <div class="space-y-6">
      <div>
        <h3 class="text-lg font-semibold text-green-700 mb-2">Good</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="text-left py-1">Faction</th>
                <th class="text-center py-1">W/L</th>
                <th class="text-center py-1">Win%</th>
                <th class="text-center py-1">Games</th>
                <th class="text-center py-1" title="Hero Kill/Death ratio">H K/D</th>
                <th class="text-center py-1" title="Hero Uptime %">H Up%</th>
                <th class="text-center py-1" title="Average Castles Razed">CK</th>
                <th class="text-center py-1" title="Times top hero killer on team">Top HK</th>
                <th class="text-center py-1" title="Times top unit killer on team">Top UK</th>
              </tr>
            </thead>
            <tbody>
              <% good_factions.each do |faction| %>
                <% fs = stats[:faction_stats][faction.id] %>
                <% next unless fs && fs[:games] > 0 %>
                <% efs = event_stats&.dig(:faction_stats, faction.id) %>
                <tr class="border-b border-gray-100">
                  <td class="py-1">
                    <span class="inline-flex items-center gap-1.5">
                      <span class="w-2.5 h-2.5 rounded-full" style="background-color: <%= faction.color_hex %>"></span>
                      <%= link_to faction.name, faction_path(faction), class: "text-blue-600 hover:underline" %>
                    </span>
                  </td>
                  <td class="text-center py-1">
                    <span class="text-green-600"><%= fs[:wins] %></span>/<span class="text-red-600"><%= fs[:losses] %></span>
                  </td>
                  <td class="text-center py-1"><%= fs[:win_rate] %>%</td>
                  <td class="text-center py-1 text-gray-500"><%= fs[:games] %></td>
                  <td class="text-center py-1"><%= efs&.dig(:hero_kd_ratio) || "-" %></td>
                  <td class="text-center py-1"><%= efs ? "#{efs[:hero_uptime]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_castles_razed] > 0 ? number_with_precision(fs[:avg_castles_razed], precision: 2) : "-" %></td>
                  <td class="text-center py-1"><%= number_with_precision(fs[:times_top_hero_kills], precision: 1) %></td>
                  <td class="text-center py-1"><%= number_with_precision(fs[:times_top_unit_kills], precision: 1) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <h3 class="text-lg font-semibold text-red-700 mb-2">Evil</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="text-left py-1">Faction</th>
                <th class="text-center py-1">W/L</th>
                <th class="text-center py-1">Win%</th>
                <th class="text-center py-1">Games</th>
                <th class="text-center py-1" title="Hero Kill/Death ratio">H K/D</th>
                <th class="text-center py-1" title="Hero Uptime %">H Up%</th>
                <th class="text-center py-1" title="Average Castles Razed">CK</th>
                <th class="text-center py-1" title="Times top hero killer on team">Top HK</th>
                <th class="text-center py-1" title="Times top unit killer on team">Top UK</th>
              </tr>
            </thead>
            <tbody>
              <% evil_factions.each do |faction| %>
                <% fs = stats[:faction_stats][faction.id] %>
                <% next unless fs && fs[:games] > 0 %>
                <% efs = event_stats&.dig(:faction_stats, faction.id) %>
                <tr class="border-b border-gray-100">
                  <td class="py-1">
                    <span class="inline-flex items-center gap-1.5">
                      <span class="w-2.5 h-2.5 rounded-full" style="background-color: <%= faction.color_hex %>"></span>
                      <%= link_to faction.name, faction_path(faction), class: "text-blue-600 hover:underline" %>
                    </span>
                  </td>
                  <td class="text-center py-1">
                    <span class="text-green-600"><%= fs[:wins] %></span>/<span class="text-red-600"><%= fs[:losses] %></span>
                  </td>
                  <td class="text-center py-1"><%= fs[:win_rate] %>%</td>
                  <td class="text-center py-1 text-gray-500"><%= fs[:games] %></td>
                  <td class="text-center py-1"><%= efs&.dig(:hero_kd_ratio) || "-" %></td>
                  <td class="text-center py-1"><%= efs ? "#{efs[:hero_uptime]}%" : "-" %></td>
                  <td class="text-center py-1"><%= fs[:avg_castles_razed] > 0 ? number_with_precision(fs[:avg_castles_razed], precision: 2) : "-" %></td>
                  <td class="text-center py-1"><%= number_with_precision(fs[:times_top_hero_kills], precision: 1) %></td>
                  <td class="text-center py-1"><%= number_with_precision(fs[:times_top_unit_kills], precision: 1) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% else %>
    <div>No appearances recorded.</div>
  <% end %>

  <h2 class="text-2xl font-bold mb-3">Match History</h2>
  <% if appearances.any? %>
    <div class="overflow-x-auto">
      <table class="w-full text-sm border border-gray-200 rounded">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Faction</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase">Result</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Hero Kills">HK</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Unit Kills">UK</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Heroes Lost">HL</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Bases Lost">BL</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Castles Razed">CK</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="ELO change">+/-</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="ELO after match">ELO</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Glicko-2 change">G+/-</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase" title="Glicko-2 after match">Glicko</th>
            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase">Duration</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% appearances.each do |appearance| %>
            <% match = appearance.match %>
            <% faction = appearance.faction %>
            <% player_won = (faction.good? && match.good_victory?) || (!faction.good? && !match.good_victory?) %>
            <% match_date = (match.uploaded_at || match.created_at).strftime('%Y-%m-%d') %>
            <tr class="<%= player_won ? 'bg-green-50' : 'bg-red-50' %>">
              <td class="px-2 py-1 whitespace-nowrap">
                <%= link_to match_date, match_path(match), class: "text-blue-600 hover:underline" %>
              </td>
              <td class="px-2 py-1 whitespace-nowrap">
                <span class="inline-flex items-center gap-1">
                  <span class="w-2.5 h-2.5 rounded-full" style="background-color: <%= faction.color_hex %>"></span>
                  <%= faction.name %>
                </span>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if player_won %>
                  <span class="text-green-600 font-medium">Win</span>
                <% else %>
                  <span class="text-red-600 font-medium">Loss</span>
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= appearance.hero_kills || '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= appearance.unit_kills || '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= heroes_lost_for_appearance(appearance) || '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= bases_lost_for_appearance(appearance) || '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap"><%= appearance.castles_razed || '-' %></td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.elo_rating_change %>
                  <% if appearance.elo_rating_change > 0 %>
                    <span class="text-green-600">+<%= appearance.elo_rating_change %></span>
                  <% elsif appearance.elo_rating_change < 0 %>
                    <span class="text-red-600"><%= appearance.elo_rating_change %></span>
                  <% else %>
                    <span class="text-gray-400">0</span>
                  <% end %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.elo_rating && appearance.elo_rating_change %>
                  <%= appearance.elo_rating + appearance.elo_rating_change %>
                <% elsif appearance.elo_rating %>
                  <%= appearance.elo_rating %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.glicko2_rating_change %>
                  <% if appearance.glicko2_rating_change > 0 %>
                    <span class="text-green-600">+<%= appearance.glicko2_rating_change.round %></span>
                  <% elsif appearance.glicko2_rating_change < 0 %>
                    <span class="text-red-600"><%= appearance.glicko2_rating_change.round %></span>
                  <% else %>
                    <span class="text-gray-400">0</span>
                  <% end %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap">
                <% if appearance.glicko2_rating && appearance.glicko2_rating_change %>
                  <%= (appearance.glicko2_rating + appearance.glicko2_rating_change).round %>
                <% elsif appearance.glicko2_rating %>
                  <%= appearance.glicko2_rating.round %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-2 py-1 text-center whitespace-nowrap text-gray-500">
                <% if match.seconds %>
                  <%= "#{match.seconds / 60}m" %>
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div>No matches found.</div>
  <% end %>
</div>
